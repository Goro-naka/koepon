# こえポン！（Koepon!） 要件定義書

## 概要

個人VTuberのデジタルコンテンツをガチャ形式で販売するプラットフォーム。ユーザーは直接課金（100円/1000円）でガチャを購入し、結果として推しメダルを獲得する。獲得した推しメダルは交換所で特典と交換でき、必ず価値に変換できる安心設計を提供する。射幸性を抑えつつ継続利用を促すため、推しメダル（VTuber専用ポイント）による交換制を併用し、法令遵守を徹底したサービス。

## ユーザストーリー

### ストーリー1: ファンとしてガチャを楽しむ

- **である** VTuberファン **として**
- **私は** 推しのデジタルコンテンツをガチャで購入 **したい**
- **そうすることで** 推しを応援しながらランダムな楽しみを体験できる

### ストーリー2: 推しメダルを活用する

- **である** ガチャ購入者 **として**
- **私は** 獲得した推しメダルを特典と交換 **したい**
- **そうすることで** ガチャの結果に関わらず必ず価値を得られる

### ストーリー3: VTuberとしてコンテンツを販売する

- **である** 個人VTuber **として**
- **私は** 自分のデジタルコンテンツをガチャ形式で販売 **したい**
- **そうすることで** ファンエンゲージメントを高めながら収益化できる


## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは単発（100円）および10連（1000円）の直接課金ガチャ購入オプションを提供しなければならない
- REQ-002: システムはガチャ結果として推しメダルを付与しなければならない（VTuber設定により枚数変更可能）
- REQ-003: システムは獲得した推しメダルをVTuber別に管理・蓄積しなければならない
- REQ-004: システムは交換所で推しメダルとデジタル特典の交換機能を提供しなければならない
- REQ-005: システムはデジタル特典（音声/画像/動画）の即時配布を実行しなければならない
- REQ-006: システムは特典BOXで購入・獲得した特典のダウンロード機能を提供しなければならない
- REQ-007: システムは排出率と特典条件を明確に表示しなければならない
- REQ-008: システムはサーバー側RNGで重み付き抽選を実行しなければならない
- REQ-009: システムはVTuberごとの専用ページを提供しなければならない
- REQ-010: システムは署名付きURLによる安全なファイルダウンロードを提供しなければならない

### 条件付き要件

- REQ-101: 決済が成功した場合、システムは即座に抽選を実行し、結果に応じて推しメダルを付与しなければならない
- REQ-102: ユーザーが交換所でアイテムを交換した場合、システムは推しメダル残高を減算しなければならない
- REQ-103: VTuberがガチャを作成する場合、システムはラインナップ・排出率・特典設定を必須としなければならない
- REQ-104: ユーザーが特典を獲得した場合、システムは即座に特典BOXに反映しなければならない
- REQ-105: 交換アイテムが上限に達した場合、システムはそれ以上の交換を禁止しなければならない
- REQ-106: ガチャ期間が終了した場合、システムは新規購入を停止しなければならない
- REQ-107: ファイルサイズが制限を超える場合、システムはアップロードを拒否しなければならない

### 状態要件

- REQ-201: ユーザーが未ログイン状態にある場合、システムはガチャ購入を許可してはならない
- REQ-202: ガチャが公開状態にある場合、システムは購入・閲覧を許可しなければならない
- REQ-203: 交換アイテムが公開期間内にある場合、システムは交換を許可しなければならない
- REQ-204: 決済処理中の場合、システムは重複購入を防止しなければならない
- REQ-205: VTuberが審査済み状態にある場合、システムはガチャ作成を許可しなければならない

### オプション要件

- REQ-301: システムはキャンペーン倍率による推しメダル増量機能を提供してもよい
- REQ-302: システムは商品画像から自動サムネイル生成を実行してもよい
- REQ-303: システムはガチャのプレビュー機能を提供してもよい
- REQ-304: システムは過去ガチャのアーカイブ表示を提供してもよい

### 制約要件

- REQ-401: システムはStripeまたはKOMOJUによる決済のみを受け付けなければならない
- REQ-402: システムはJPY（日本円）のみで価格設定しなければならない
- REQ-403: システムはZIP/MP3/PNG/JPEG/WebP/MP4形式のファイルのみを受け付けなければならない
- REQ-404: システムはTLS通信を使用しなければならない
- REQ-405: システムは特定商取引法に基づく表記を表示しなければならない
- REQ-406: システムは景品表示法に準拠した排出率表示を行わなければならない
- REQ-407: システムは著作権・肖像権の契約に基づいた利用範囲を遵守しなければならない
- REQ-408: システムは返金不可の条件を明記しなければならない
- REQ-409: システムは冪等性キーによる多重決済防止を実装しなければならない
- REQ-410: システムは直リンクによるファイルアクセスを防止しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: システムは販売開始直後のスパイクアクセスに対して水平スケールで対応しなければならない
- NFR-002: ガチャ抽選処理は3秒以内に完了しなければならない
- NFR-003: 特典ダウンロードは署名付きURL生成から5秒以内に開始しなければならない
- NFR-004: システムはCDNを活用して静的コンテンツを配信しなければならない
- NFR-005: データベースクエリは100ms以内にレスポンスを返さなければならない

### セキュリティ

- NFR-101: システムはOWASP ASVS Level 2に準拠したセキュリティ対策を実装しなければならない
- NFR-102: パスワードは適切にハッシュ化して保存しなければならない
- NFR-103: APIエンドポイントは認証・認可を必須としなければならない
- NFR-104: ファイルアップロードは拡張子とMIMEタイプを検証しなければならない
- NFR-105: SQLインジェクション対策を実装しなければならない
- NFR-106: XSS対策として入力値のサニタイズを実施しなければならない
- NFR-107: CSRF対策トークンを実装しなければならない

### ユーザビリティ

- NFR-201: モバイルファーストのレスポンシブデザインを採用しなければならない
- NFR-202: ガチャ結果は視覚的に魅力的なアニメーションで表示しなければならない
- NFR-203: エラーメッセージは具体的で理解しやすい内容にしなければならない
- NFR-204: 主要操作は3クリック以内で完了できるようにしなければならない
- NFR-205: ローディング中は適切なインジケータを表示しなければならない

### 可用性

- NFR-301: システムは99.5%以上の可用性を維持しなければならない
- NFR-302: 計画メンテナンスは深夜帯に実施しなければならない
- NFR-303: データベースは自動バックアップを日次で実行しなければならない
- NFR-304: 障害発生時は1時間以内に復旧しなければならない

### 法令遵守

- NFR-401: 特定商取引法に基づく表記を全ページからアクセス可能にしなければならない
- NFR-402: 景品表示法に準拠し、誤認を招かない表示をしなければならない
- NFR-403: 個人情報保護法に準拠したプライバシーポリシーを掲示しなければならない
- NFR-404: 著作権・肖像権の利用許諾範囲を遵守しなければならない
- NFR-405: 利用規約への同意を必須としなければならない

## Edgeケース

### エラー処理

- EDGE-001: 決済成功後、抽選処理が失敗した場合、システムは抽選を再試行し、それでも失敗する場合は返金処理を開始する
- EDGE-002: ファイルダウンロード中に接続が切断された場合、システムは再開可能なダウンロードを提供する
- EDGE-003: 同時に同じアイテムを交換しようとした場合、システムは先着順で処理し、後続リクエストはエラーを返す
- EDGE-004: VTuberがガチャ期間中にアイテムを削除しようとした場合、システムは操作を拒否する
- EDGE-005: 推しメダル残高が不足している場合、システムは交換を拒否し、不足枚数を表示する
- EDGE-006: Webhook通知が重複した場合、システムは冪等性キーで重複を検知し、処理をスキップする
- EDGE-007: ストレージ容量が不足した場合、システムは新規アップロードを停止し、管理者に通知する

### 境界値

- EDGE-101: 推しメダル残高が0の場合、交換所は「交換可能なアイテムがありません」と表示する
- EDGE-102: ガチャ期間の終了1分前に購入した場合でも、システムは正常に処理を完了する
- EDGE-103: 10連ガチャで全て同じアイテムが出た場合でも、システムは正常に処理する
- EDGE-104: ファイルサイズが上限ギリギリ（100MB）の場合でも、システムは正常にアップロード・配信する
- EDGE-105: 交換上限が1の場合、2回目の交換試行は確実に拒否される
- EDGE-106: 排出率が0.01%のアイテムでも、正確に抽選される

### 同時実行

- EDGE-201: 複数ユーザーが同時に同じガチャを購入した場合、全員が独立して抽選される
- EDGE-202: 複数デバイスから同一アカウントでログインした場合、セッション管理が適切に行われる
- EDGE-203: 大量のダウンロードリクエストが同時に発生した場合、CDNが適切に負荷分散する

### データ整合性

- EDGE-301: トランザクション中にシステムエラーが発生した場合、ロールバックして整合性を保つ
- EDGE-302: 推しメダルの加算と決済が不整合になった場合、監査ログから復元可能にする

## 受け入れ基準

### 機能テスト

#### ガチャ機能
- [ ] 単発ガチャが正常に購入・抽選できる
- [ ] 10連ガチャが正常に購入・抽選できる
- [ ] 10連特典が確実に付与される
- [ ] 排出率に基づいた抽選が行われる
- [ ] ガチャ結果が正しく表示される
- [ ] ガチャ履歴が正確に記録される

#### 推しメダル機能
- [ ] ガチャ結果として推しメダルが付与される
- [ ] VTuber別に推しメダルが管理される
- [ ] 推しメダル残高が正確に表示される
- [ ] 交換時に推しメダルが正しく減算される
- [ ] 推しメダルは購入不可（ガチャ結果としてのみ獲得可能）


#### 交換所機能
- [ ] 交換可能アイテムが正しく表示される
- [ ] 必要メダル数のチェックが機能する
- [ ] 交換上限のチェックが機能する
- [ ] 交換期間のチェックが機能する
- [ ] 交換成功時に特典BOXに即座に反映される

#### 特典配布機能
- [ ] デジタル特典が即時ダウンロード可能になる
- [ ] 署名付きURLが正しく生成される
- [ ] 対応ファイル形式のみ受け付ける
- [ ] ファイルサイズ制限が機能する

#### VTuber管理機能
- [ ] ガチャの作成・編集が正常に動作する
- [ ] ラインナップの登録が正常に動作する
- [ ] 特典設定が正常に保存される
- [ ] 交換所の設定が正常に動作する
- [ ] 売上レポートが正確に表示される

#### 決済機能
- [ ] Stripe決済で直接ガチャ購入（100円/1000円）が処理される
- [ ] KOMOJU決済で直接ガチャ購入（100円/1000円）が処理される
- [ ] 決済完了後に自動で抽選が実行される
- [ ] 決済完了後に推しメダルが付与される
- [ ] 重複決済が防止される
- [ ] 決済エラー時の処理が適切に行われる

### 非機能テスト

#### パフォーマンステスト
- [ ] 1000人同時アクセスでレスポンス3秒以内
- [ ] ガチャ抽選が3秒以内に完了
- [ ] ファイルダウンロードが5秒以内に開始
- [ ] データベースクエリが100ms以内

#### セキュリティテスト
- [ ] SQLインジェクション攻撃を防御できる
- [ ] XSS攻撃を防御できる
- [ ] CSRF攻撃を防御できる
- [ ] 直リンクアクセスを防止できる
- [ ] 認証なしでのAPI呼び出しを拒否する

#### ユーザビリティテスト
- [ ] モバイル端末で全機能が利用可能
- [ ] 主要操作が3クリック以内で完了
- [ ] エラーメッセージが分かりやすい
- [ ] ローディング表示が適切

#### 法令遵守テスト
- [ ] 特定商取引法表記が全ページから確認可能
- [ ] 排出率が正確に表示される
- [ ] 利用規約への同意フローが機能する
- [ ] 年齢確認機能が動作する

#### 障害対応テスト
- [ ] サーバー障害時の自動フェイルオーバー
- [ ] データベース障害時のリードレプリカ切り替え
- [ ] バックアップからのリストアが可能
- [ ] 監査ログから不整合データの復元が可能

## 実装優先順位

### Phase 1（MVP）
1. 基本的なガチャ機能（単発・10連）
2. 推しメダルシステム
3. 決済機能（Stripe）
4. 特典BOX・ダウンロード機能
5. 基本的な認証機能

### Phase 2（機能拡張）
1. 交換所機能
2. VTuber管理コンソール
3. KOMOJU決済追加
4. 詳細なレポート機能

### Phase 3（最適化）
1. パフォーマンス最適化
2. 高度なセキュリティ対策
3. 分析ダッシュボード
4. キャンペーン機能
5. 自動スケーリング対応

## リスクと対策

### 技術的リスク
- **リスク**: 販売開始時のアクセス集中
- **対策**: オートスケーリング、CDN活用、キューイングシステム

### 法的リスク
- **リスク**: 景品表示法違反
- **対策**: 法務確認、排出率の正確な表示、定期的な監査

### ビジネスリスク
- **リスク**: 射幸性による批判
- **対策**: 推しメダルシステムによる価値保証、上限設定機能

## 用語集

| 用語 | 定義 |
|------|------|
| ガチャ | 設定期間・価格で購入できるランダム排出販売 |
| 推しメダル | ガチャ1回ごとに得るVTuber専用ポイント |
| 交換所 | 推しメダルを特典と交換できる機能 |
| 特典BOX | 獲得特典の保管・ダウンロード場所 |
| RNG | Random Number Generator（乱数生成器） |
| 冪等性キー | 重複処理を防ぐための一意識別子 |

## 改訂履歴

| 版 | 日付 | 変更内容 | 作成者 |
|----|------|----------|--------|
| 1.0 | 2025-08-25 | 初版作成 | EARS記法による要件定義 |