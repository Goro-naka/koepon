# TASK-402: 認証画面実装 - TDD要件定義

## 概要

こえポン！アプリケーションにおける認証機能のフロントエンド実装。ユーザーがログイン、新規登録、パスワードリセットを行うためのUIコンポーネントを提供する。

## 対象画面

### 1. ログイン画面 (`/login`)

#### 基本要件
- **URL**: `/login`
- **目的**: 既存ユーザーのログイン
- **認証後遷移先**: ダッシュボード（`/dashboard`）または指定されたリダイレクト先

#### UI要素
1. **フォームフィールド**
   - メールアドレス入力（必須、email validation）
   - パスワード入力（必須、8文字以上）
   - パスワード表示/非表示トグルボタン
   - "ログイン状態を保持" チェックボックス

2. **アクションボタン**
   - ログインボタン（メインCTA、ローディング状態対応）
   - "新規登録はこちら" リンク
   - "パスワードを忘れた方はこちら" リンク

3. **フィードバック表示**
   - バリデーションエラーメッセージ（フィールド下部）
   - 認証エラーメッセージ（フォーム上部）
   - ローディング状態（ボタン無効化 + スピナー）

#### UI/UX要件
- **ローディング状態**: ログインボタン無効化、スピナー表示、"ログイン中..." テキスト
- **エラー表示**: フィールド下部に赤色でエラーメッセージ表示
- **モバイル対応**: タッチフレンドリーなフォーム（最小44px タッチターゲット）
- **アクセシビリティ**: 
  - ラベルとフィールドの適切な関連付け（`htmlFor`）
  - エラーメッセージの `aria-describedby` 設定
  - キーボードナビゲーション対応
  - スクリーンリーダー対応

### 2. ユーザー登録画面 (`/register`)

#### 基本要件
- **URL**: `/register`
- **目的**: 新規ユーザーの会員登録
- **認証後遷移先**: ウェルカム画面（`/welcome`）

#### UI要素
1. **フォームフィールド**
   - メールアドレス入力（必須、email validation、重複チェック）
   - ユーザー名入力（必須、3-20文字、英数字・_のみ、重複チェック）
   - 表示名入力（任意、1-50文字）
   - パスワード入力（必須、8文字以上、強度指標表示）
   - パスワード確認入力（必須、パスワードと一致）
   - 生年月日選択（必須、13歳以上制限）

2. **チェックボックス**
   - 利用規約同意（必須）
   - プライバシーポリシー同意（必須）
   - メール配信同意（任意）

3. **アクションボタン**
   - 新規登録ボタン（メインCTA、ローディング状態対応）
   - "ログインはこちら" リンク

4. **フィードバック表示**
   - リアルタイムバリデーション（入力中）
   - パスワード強度インジケーター
   - 重複チェック結果（ユーザー名・メール）
   - 登録エラーメッセージ

#### UI/UX要件
- **ローディング状態**: 登録ボタン無効化、スピナー表示、"登録中..." テキスト
- **リアルタイム検証**: フォーカスアウト時にバリデーション実行
- **パスワード強度**: 弱・中・強の3段階で視覚的表示
- **年齢制限**: 13歳未満の場合はエラー表示
- **モバイル対応**: 縦スクロール対応、適切なinput type使用
- **アクセシビリティ**: フォーム全体の適切なラベリング

### 3. パスワードリセット画面 (`/password-reset`)

#### 基本要件
- **URL**: `/password-reset`
- **目的**: パスワードを忘れたユーザーのパスワード再設定
- **フロー**: メール送信 → メール確認 → パスワード再設定

#### UI要素（メール送信画面）
1. **フォームフィールド**
   - メールアドレス入力（必須）

2. **アクションボタン**
   - リセットメール送信ボタン
   - "ログインに戻る" リンク

3. **フィードバック表示**
   - 送信完了メッセージ
   - エラーメッセージ

## バリデーション要件

### クライアントサイドバリデーション

1. **メールアドレス**
   - フォーマット検証（正規表現）
   - 必須チェック
   - 最大254文字制限

2. **パスワード**
   - 最小8文字
   - 英数字を含む（推奨）
   - 特殊文字を含む（推奨）
   - 最大128文字制限

3. **ユーザー名**
   - 3-20文字
   - 英数字とアンダースコアのみ
   - 先頭数字禁止
   - 予約語チェック

4. **表示名**
   - 1-50文字
   - 絵文字対応
   - 不適切な語句チェック

5. **生年月日**
   - 13歳以上
   - 未来日付禁止
   - 120歳以上禁止

### サーバーサイド連携

1. **重複チェック**
   - メールアドレス重複API呼び出し
   - ユーザー名重複API呼び出し
   - デバウンス機能（500ms）

2. **認証API呼び出し**
   - ログインAPI（POST `/api/v1/auth/login`）
   - 登録API（POST `/api/v1/auth/register`）
   - パスワードリセットAPI（POST `/api/v1/auth/password-reset`）

## エラーハンドリング

### ネットワークエラー
- 接続エラー: "接続に失敗しました。しばらくしてからお試しください。"
- タイムアウト: "処理がタイムアウトしました。再度お試しください。"

### バリデーションエラー
- フィールド単位でのエラー表示
- フォーム全体での統合エラー表示
- アクセシブルなエラー通知

### 認証エラー
- ログイン失敗: "メールアドレスまたはパスワードが間違っています"
- アカウントロック: "アカウントがロックされています。しばらくしてからお試しください"
- メールアドレス未認証: "メールアドレスの認証が完了していません"

### サーバーエラー
- 500エラー: "サーバーエラーが発生しました。時間をおいて再度お試しください"
- メンテナンス中: "現在メンテナンス中です。ご迷惑をおかけします"

## セキュリティ要件

### クライアントサイド
1. **パスワード保護**
   - パスワードフィールドのオートコンプリート無効化
   - パスワードの平文保存禁止
   - ブラウザ履歴からの除外

2. **CSRF対策**
   - CSRFトークンの適切な送信
   - フォーム送信時の検証

3. **XSS対策**
   - 入力値のサニタイゼーション
   - HTMLエスケープ

### 状態管理
1. **認証状態**
   - Zustandでのトークン管理
   - ローカルストレージへの安全な保存
   - 自動ログアウト機能

2. **セッション管理**
   - リフレッシュトークンでの自動更新
   - トークン期限切れ時の適切な処理

## パフォーマンス要件

### レスポンス時間
- フォーム送信から結果表示まで3秒以内
- バリデーション結果の即座表示（100ms以内）
- ページ読み込み時間2秒以内

### リソース最適化
- 画像の遅延読み込み
- コンポーネントのcode splitting
- 不要なre-renderの防止

## 受け入れ基準

### 機能要件
1. ✅ ユーザーが正しい認証情報でログインできる
2. ✅ ユーザーが新規アカウントを作成できる
3. ✅ ユーザーがパスワードリセットできる
4. ✅ バリデーションエラーが適切に表示される
5. ✅ ローディング状態が視覚的に確認できる

### 品質要件
1. ✅ レスポンシブデザイン（モバイル・タブレット・デスクトップ）
2. ✅ アクセシビリティ基準（WCAG 2.1 AA準拠）
3. ✅ ブラウザ互換性（Chrome、Firefox、Safari、Edge）
4. ✅ パフォーマンス基準（Core Web Vitals合格）

### セキュリティ要件
1. ✅ 適切な入力値検証
2. ✅ セキュアなパスワード処理
3. ✅ CSRF・XSS対策実装

## 技術仕様

### 使用技術
- **フレームワーク**: Next.js 14 (App Router)
- **UIライブラリ**: shadcn/ui + Radix UI
- **スタイリング**: Tailwind CSS v4
- **状態管理**: Zustand
- **フォーム管理**: React Hook Form + zod
- **API通信**: TanStack Query + axios
- **テスト**: Jest + React Testing Library + Playwright

### ファイル構成
```
client/src/app/
├── login/
│   └── page.tsx                 # ログインページ
├── register/
│   └── page.tsx                 # 登録ページ
└── password-reset/
    └── page.tsx                 # パスワードリセットページ

client/src/components/
├── auth/
│   ├── login-form.tsx           # ログインフォーム
│   ├── register-form.tsx        # 登録フォーム
│   └── password-reset-form.tsx  # パスワードリセットフォーム
└── ui/
    ├── form.tsx                 # フォーム基本コンポーネント
    ├── input.tsx                # 入力フィールド
    ├── checkbox.tsx             # チェックボックス
    └── alert.tsx                # アラート表示

client/src/hooks/
├── use-auth.ts                  # 認証関連hooks
└── use-validation.ts            # バリデーション hooks

client/src/lib/
├── auth-api.ts                  # 認証API関数
└── validation-schemas.ts        # zodバリデーションスキーマ
```

この要件定義に基づいて、次のステップでテストケースを作成し、TDDサイクルを進めていきます。