# TASK-402: 認証画面実装 - TDDテストケース設計

## テスト戦略

### テストレベル
1. **コンポーネント単体テスト** (Jest + React Testing Library)
2. **統合テスト** (API連携含む)
3. **E2Eテスト** (Playwright)
4. **アクセシビリティテスト** (axe-core)

### テスト環境
- **Node.js環境**: Jest + jsdom
- **ブラウザ環境**: Playwright
- **モバイル環境**: Chrome DevTools + Playwright

## 1. ログインフォーム（LoginForm）テストケース

### コンポーネント単体テスト

#### LC001: 基本レンダリングテスト
```typescript
describe('LoginForm - Basic Rendering', () => {
  test('すべての必要なフォーム要素がレンダリングされる', () => {
    // GIVEN: ログインフォームをレンダリング
    // WHEN: ページを表示
    // THEN: 以下の要素が存在する
    //   - メールアドレス入力フィールド
    //   - パスワード入力フィールド
    //   - パスワード表示/非表示トグル
    //   - "ログイン状態を保持"チェックボックス
    //   - ログインボタン
    //   - "新規登録はこちら"リンク
    //   - "パスワードを忘れた方はこちら"リンク
  })

  test('初期状態でフォームが空になっている', () => {
    // GIVEN: ログインフォームをレンダリング
    // WHEN: ページを表示
    // THEN: すべての入力フィールドが空
  })
})`
```

#### LC002: フォーム入力テスト
```typescript
describe('LoginForm - Form Input', () => {
  test('メールアドレスが入力できる', () => {
    // GIVEN: ログインフォームを表示
    // WHEN: メールフィールドに'test@example.com'を入力
    // THEN: 入力値が反映される
  })

  test('パスワードが入力できる', () => {
    // GIVEN: ログインフォームを表示  
    // WHEN: パスワードフィールドに'password123'を入力
    // THEN: 入力値が反映される（マスクされた状態）
  })

  test('パスワード表示トグルが動作する', () => {
    // GIVEN: パスワードを入力済み
    // WHEN: パスワード表示トグルをクリック
    // THEN: パスワードが平文で表示される
  })

  test('ログイン状態保持チェックボックスが切り替わる', () => {
    // GIVEN: ログインフォームを表示
    // WHEN: チェックボックスをクリック
    // THEN: チェック状態が切り替わる
  })
})
```

#### LC003: バリデーションテスト
```typescript
describe('LoginForm - Validation', () => {
  test('メールアドレス必須チェック', () => {
    // GIVEN: メールアドレスを空にする
    // WHEN: ログインボタンをクリック
    // THEN: "メールアドレスは必須です"エラーが表示される
  })

  test('メールアドレス形式チェック', () => {
    // GIVEN: 無効なメールアドレス'invalid-email'を入力
    // WHEN: フィールドからフォーカスアウト
    // THEN: "正しいメールアドレスを入力してください"エラーが表示される
  })

  test('パスワード必須チェック', () => {
    // GIVEN: パスワードを空にする
    // WHEN: ログインボタンをクリック
    // THEN: "パスワードは必須です"エラーが表示される
  })

  test('複数エラーが同時表示される', () => {
    // GIVEN: 空のフォーム
    // WHEN: ログインボタンをクリック
    // THEN: メールとパスワード両方のエラーが表示される
  })
})
```

#### LC004: 送信・ローディングテスト
```typescript
describe('LoginForm - Submission and Loading', () => {
  test('正しい入力値でフォーム送信される', async () => {
    // GIVEN: 正しいメール・パスワードを入力
    // WHEN: ログインボタンをクリック
    // THEN: API呼び出しが正しいパラメータで実行される
  })

  test('送信中にローディング状態が表示される', async () => {
    // GIVEN: ログイン処理を開始
    // WHEN: API呼び出し中
    // THEN: 
    //   - ログインボタンが無効化される
    //   - スピナーが表示される
    //   - "ログイン中..."テキストが表示される
  })

  test('送信成功時にリダイレクトされる', async () => {
    // GIVEN: 正しいログイン情報を入力
    // WHEN: ログインが成功
    // THEN: ダッシュボードページにリダイレクトされる
  })
})
```

#### LC005: エラーハンドリングテスト
```typescript
describe('LoginForm - Error Handling', () => {
  test('認証失敗エラーが表示される', async () => {
    // GIVEN: 間違ったログイン情報を入力
    // WHEN: ログイン実行
    // THEN: "メールアドレスまたはパスワードが間違っています"が表示される
  })

  test('ネットワークエラーが表示される', async () => {
    // GIVEN: ネットワーク接続がない状態
    // WHEN: ログイン実行
    // THEN: "接続に失敗しました"エラーが表示される
  })

  test('サーバーエラーが表示される', async () => {
    // GIVEN: サーバーが500エラーを返す
    // WHEN: ログイン実行  
    // THEN: "サーバーエラーが発生しました"が表示される
  })
})
```

## 2. ユーザー登録フォーム（RegisterForm）テストケース

### コンポーネント単体テスト

#### RC001: 基本レンダリングテスト
```typescript
describe('RegisterForm - Basic Rendering', () => {
  test('すべての必要なフォーム要素がレンダリングされる', () => {
    // GIVEN: 登録フォームをレンダリング
    // WHEN: ページを表示
    // THEN: 以下の要素が存在する
    //   - メールアドレス入力
    //   - ユーザー名入力
    //   - 表示名入力
    //   - パスワード入力
    //   - パスワード確認入力
    //   - 生年月日選択（年・月・日）
    //   - 利用規約同意チェックボックス
    //   - プライバシーポリシー同意チェックボックス
    //   - メール配信同意チェックボックス（任意）
    //   - 新規登録ボタン
    //   - ログインリンク
  })
})
```

#### RC002: バリデーションテスト（基本項目）
```typescript
describe('RegisterForm - Basic Validation', () => {
  test('メールアドレス必須・形式チェック', () => {
    // ケース1: 空の場合
    // GIVEN: メールアドレスを空にする
    // WHEN: 他のフィールドにフォーカス移動
    // THEN: "メールアドレスは必須です"エラー表示

    // ケース2: 形式が無効な場合
    // GIVEN: 'invalid-email'を入力
    // WHEN: フォーカスアウト
    // THEN: "正しいメールアドレスを入力してください"エラー表示
  })

  test('ユーザー名バリデーション', () => {
    // ケース1: 文字数不足
    // GIVEN: 'ab'（2文字）を入力
    // WHEN: フォーカスアウト
    // THEN: "ユーザー名は3文字以上である必要があります"エラー表示

    // ケース2: 文字数過多  
    // GIVEN: 21文字の文字列を入力
    // WHEN: フォーカスアウト
    // THEN: "ユーザー名は20文字以下である必要があります"エラー表示

    // ケース3: 使用禁止文字
    // GIVEN: 'test-user'（ハイフン使用）を入力
    // WHEN: フォーカスアウト
    // THEN: "英数字とアンダースコアのみ使用できます"エラー表示

    // ケース4: 先頭数字
    // GIVEN: '123user'を入力
    // WHEN: フォーカスアウト
    // THEN: "先頭に数字は使用できません"エラー表示
  })

  test('パスワード強度チェック', () => {
    // ケース1: 文字数不足
    // GIVEN: '1234567'（7文字）を入力
    // WHEN: フォーカスアウト
    // THEN: "パスワードは8文字以上である必要があります"エラー表示

    // ケース2: 弱いパスワード
    // GIVEN: 'password'を入力
    // WHEN: 入力中
    // THEN: パスワード強度が"弱"で表示される

    // ケース3: 中程度のパスワード
    // GIVEN: 'password123'を入力
    // WHEN: 入力中
    // THEN: パスワード強度が"中"で表示される

    // ケース4: 強いパスワード
    // GIVEN: 'Password123!'を入力
    // WHEN: 入力中
    // THEN: パスワード強度が"強"で表示される
  })

  test('パスワード確認一致チェック', () => {
    // GIVEN: パスワードに'password123'、確認に'password456'を入力
    // WHEN: パスワード確認フィールドからフォーカスアウト
    // THEN: "パスワードが一致しません"エラー表示
  })
})
```

#### RC003: バリデーション（高度な項目）
```typescript
describe('RegisterForm - Advanced Validation', () => {
  test('年齢制限チェック', () => {
    // ケース1: 13歳未満
    // GIVEN: 12年前の日付を選択
    // WHEN: 日付選択完了
    // THEN: "13歳以上である必要があります"エラー表示

    // ケース2: 未来の日付
    // GIVEN: 来年の日付を選択
    // WHEN: 日付選択完了
    // THEN: "未来の日付は選択できません"エラー表示

    // ケース3: 120歳超過
    // GIVEN: 121年前の日付を選択
    // WHEN: 日付選択完了
    // THEN: "正しい生年月日を入力してください"エラー表示
  })

  test('必須同意項目チェック', () => {
    // GIVEN: 利用規約とプライバシーポリシーにチェックしない
    // WHEN: 登録ボタンをクリック
    // THEN: "利用規約とプライバシーポリシーに同意してください"エラー表示
  })
})
```

#### RC004: API連携テスト
```typescript
describe('RegisterForm - API Integration', () => {
  test('メールアドレス重複チェック', async () => {
    // GIVEN: 既存のメールアドレスを入力
    // WHEN: フィールドからフォーカスアウト（500msデバウンス後）
    // THEN: "このメールアドレスは既に使用されています"エラー表示
  })

  test('ユーザー名重複チェック', async () => {
    // GIVEN: 既存のユーザー名を入力
    // WHEN: フィールドからフォーカスアウト（500msデバウンス後）
    // THEN: "このユーザー名は既に使用されています"エラー表示
  })

  test('登録処理成功', async () => {
    // GIVEN: 正しい情報をすべて入力
    // WHEN: 登録ボタンをクリック
    // THEN: 
    //   - 登録APIが呼び出される
    //   - 成功時にウェルカムページにリダイレクト
    //   - Zustandストアに認証情報が保存される
  })
})
```

## 3. パスワードリセットフォーム（PasswordResetForm）テストケース

### コンポーネント単体テスト

#### PR001: 基本機能テスト
```typescript
describe('PasswordResetForm - Basic Function', () => {
  test('メール送信フォームが表示される', () => {
    // GIVEN: パスワードリセットページを表示
    // WHEN: ページロード
    // THEN: 
    //   - メールアドレス入力フィールド
    //   - リセットメール送信ボタン
    //   - "ログインに戻る"リンクが表示される
  })

  test('メール送信処理', async () => {
    // GIVEN: メールアドレス'test@example.com'を入力
    // WHEN: 送信ボタンをクリック
    // THEN: 
    //   - パスワードリセットAPIが呼び出される
    //   - 成功メッセージが表示される
    //   - "メールを送信しました。メールボックスを確認してください"
  })
})
```

## 4. アクセシビリティテストケース

### A11Y001: キーボードナビゲーション
```typescript
describe('Authentication Forms - Accessibility', () => {
  test('タブキーでフォーム要素を順番に移動できる', () => {
    // GIVEN: ログインフォームを表示
    // WHEN: タブキーを連続押下
    // THEN: 論理的な順序でフォーカスが移動する
    //   1. メールアドレス
    //   2. パスワード  
    //   3. パスワード表示トグル
    //   4. ログイン状態保持チェックボックス
    //   5. ログインボタン
    //   6. 各種リンク
  })

  test('エンターキーでフォーム送信できる', () => {
    // GIVEN: フォームの任意フィールドにフォーカス
    // WHEN: エンターキーを押下
    // THEN: フォーム送信が実行される
  })
})
```

### A11Y002: スクリーンリーダー対応
```typescript
describe('Authentication Forms - Screen Reader', () => {
  test('フォームラベルが適切に関連付けられている', () => {
    // GIVEN: フォームをレンダリング
    // WHEN: スクリーンリーダーでアクセス
    // THEN: 
    //   - 各入力フィールドに適切なラベルが設定
    //   - aria-label またはラベル要素で関連付け
    //   - 必須フィールドがaria-requiredで示される
  })

  test('エラーメッセージがアクセシブルに表示される', () => {
    // GIVEN: バリデーションエラーが発生
    // WHEN: スクリーンリーダーでアクセス
    // THEN: 
    //   - エラーメッセージがaria-describedbyで関連付け
    //   - role="alert"でエラー通知
    //   - エラー発生時に音声で読み上げ
  })
})
```

## 5. レスポンシブデザインテストケース

### RD001: ブレークポイントテスト
```typescript
describe('Authentication Forms - Responsive Design', () => {
  test('モバイル表示（320px-768px）', () => {
    // GIVEN: 画面幅をモバイルサイズに設定
    // WHEN: フォームを表示
    // THEN: 
    //   - フォーム要素が縦に配置される
    //   - タッチしやすいボタンサイズ（最小44px）
    //   - 適切な余白とパディング
  })

  test('タブレット表示（768px-1024px）', () => {
    // GIVEN: 画面幅をタブレットサイズに設定
    // WHEN: フォームを表示
    // THEN: 
    //   - フォーム幅が適切に調整される
    //   - 読みやすい行の長さ
  })

  test('デスクトップ表示（1024px以上）', () => {
    // GIVEN: 画面幅をデスクトップサイズに設定
    // WHEN: フォームを表示
    // THEN: 
    //   - センタリングされたフォームレイアウト
    //   - 最大幅の制限
  })
})
```

## 6. E2Eテストケース

### E2E001: ユーザージャーニー
```typescript
describe('Authentication E2E - User Journey', () => {
  test('新規ユーザー登録からログインまでの完全フロー', async () => {
    // GIVEN: アプリケーションにアクセス
    // WHEN: 以下の操作を順番に実行
    //   1. 新規登録ページにアクセス
    //   2. すべての必須情報を入力
    //   3. 登録ボタンをクリック
    //   4. ウェルカムページに遷移
    //   5. ログアウト
    //   6. ログインページにアクセス
    //   7. 登録した情報でログイン
    // THEN: ダッシュボードページに正常にアクセスできる
  })

  test('パスワードリセットフロー', async () => {
    // GIVEN: ログインページを表示
    // WHEN: 以下の操作を実行
    //   1. "パスワードを忘れた方"リンクをクリック
    //   2. メールアドレスを入力
    //   3. リセットメール送信
    //   4. 成功メッセージを確認
    // THEN: メール送信完了が表示される
  })
})
```

## 7. パフォーマンステストケース

### PF001: レンダリング性能
```typescript
describe('Authentication Forms - Performance', () => {
  test('初期レンダリング時間が2秒以内', async () => {
    // GIVEN: ページアクセス開始
    // WHEN: ページロード完了まで測定
    // THEN: 2秒以内でFirst Contentful Paintが完了
  })

  test('フォーム送信レスポンス時間が3秒以内', async () => {
    // GIVEN: フォーム入力完了
    // WHEN: 送信ボタンクリックから結果表示まで測定
    // THEN: 3秒以内で処理完了またはエラー表示
  })

  test('バリデーション応答時間が100ms以内', async () => {
    // GIVEN: フィールドに入力
    // WHEN: フォーカスアウトからエラー表示まで測定
    // THEN: 100ms以内でバリデーション結果表示
  })
})
```

## 8. セキュリティテストケース

### SEC001: 入力値セキュリティ
```typescript
describe('Authentication Forms - Security', () => {
  test('XSS攻撃に対する防御', () => {
    // GIVEN: 悪意のあるスクリプト'<script>alert("xss")</script>'を入力
    // WHEN: フォーム送信
    // THEN: スクリプトが実行されずエスケープされる
  })

  test('SQLインジェクション攻撃に対する防御', () => {
    // GIVEN: SQLインジェクション'admin\'; DROP TABLE users; --'を入力
    // WHEN: フォーム送信
    // THEN: 適切にエスケープされてAPIに送信される
  })

  test('パスワードが平文で送信されない', () => {
    // GIVEN: パスワードを入力
    // WHEN: 開発者ツールでネットワークタブを確認
    // THEN: パスワードがハッシュ化またはHTTPS暗号化されている
  })
})
```

## テスト実行計画

### Phase 1: 単体テスト（Red Phase）
1. **LoginForm**: LC001-LC005 (25テスト)
2. **RegisterForm**: RC001-RC004 (35テスト)  
3. **PasswordResetForm**: PR001 (8テスト)

### Phase 2: 統合テスト（Green Phase）
1. **API連携**: 認証API、重複チェックAPI
2. **状態管理**: Zustand統合
3. **ルーティング**: Next.js App Router統合

### Phase 3: 品質テスト（Refactor Phase）
1. **アクセシビリティ**: A11Y001-A11Y002 (12テスト)
2. **レスポンシブ**: RD001 (6テスト)
3. **E2E**: E2E001 (4テスト)
4. **パフォーマンス**: PF001 (6テスト)
5. **セキュリティ**: SEC001 (6テスト)

### 総テストケース数: **102テスト**

次のステップで、これらのテストケースを実装し、Red Phase（失敗テスト）から開始します。