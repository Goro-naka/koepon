# TASK-403: ガチャ画面実装 - 要件定義

## 概要

こえポン！のコア機能であるガチャシステムのフロントエンド実装。VTuberファンが推しに対してガチャを引いて特典を獲得し、推しメダルを貯めることができる魅力的なUIを提供する。

## 機能要件

### 1. ガチャ一覧画面 (GachaListPage)

#### 1.1 基本機能
- **ガチャカード表示**: 利用可能なガチャを魅力的なカード形式で表示
- **VTuber別分類**: VTuber毎にガチャをグループ化
- **検索・フィルタ**: VTuber名、価格帯、期間で絞り込み
- **ソート機能**: 価格順、人気順、新着順で並び替え

#### 1.2 カード情報
- VTuber名・アイコン
- ガチャ名・説明
- 価格（円）
- 排出率概要
- 期間限定表示
- 人気度・参加者数

#### 1.3 状態管理
- ローディング状態（スケルトンローダー）
- エラー状態（再取得ボタン付き）
- 空状態（ガチャ未登録時）

### 2. ガチャ詳細画面 (GachaDetailPage)

#### 2.1 詳細情報
- **ガチャ概要**: タイトル、説明、VTuber情報
- **価格情報**: 単発・10連・特別パックの価格
- **排出率表示**: レアリティ別の詳細確率
- **景品一覧**: 獲得可能なアイテム・特典のプレビュー
- **期間・制限**: 開催期間、購入制限、残り回数

#### 2.2 購入オプション
- **単発ガチャ**: 1回分の購入
- **10連ガチャ**: まとめ購入（割引・特典あり）
- **定期購入**: 月額プランオプション（将来実装）

#### 2.3 インタラクション
- **ガチャ実行ボタン**: 魅力的なCTA
- **確認モーダル**: 購入前の最終確認
- **履歴リンク**: 過去の抽選結果確認

### 3. 抽選実行画面 (GachaDrawPage)

#### 3.1 抽選演出
- **アニメーション**: 3秒以内の魅力的な抽選演出
- **サウンドエフェクト**: 抽選中・結果時の効果音
- **進行表示**: ローディングプログレス
- **中断不可**: 抽選中の誤操作防止

#### 3.2 結果表示
- **獲得アイテム表示**: 大きく魅力的な結果表示
- **レアリティ演出**: レア度に応じた特別エフェクト
- **推しメダル獲得**: 獲得メダル数の強調表示
- **シェア機能**: SNS共有ボタン

#### 3.3 連続抽選
- **10連ガチャ対応**: 連続抽選の演出
- **まとめ結果**: 10回分の結果を一覧表示
- **特別演出**: 高レア獲得時の特別エフェクト

### 4. 抽選履歴画面 (GachaHistoryPage)

#### 4.1 履歴表示
- **抽選記録**: 日時、ガチャ名、結果、獲得メダル
- **フィルタリング**: VTuber別、期間別、レアリティ別
- **統計情報**: 総抽選回数、総獲得メダル、レア率

#### 4.2 詳細機能
- **再抽選リンク**: 同じガチャへの快速アクセス
- **お気に入り**: よく引くガチャの保存
- **エクスポート**: 履歴のCSV出力（将来実装）

## UI/UX要件

### 1. デザインシステム

#### 1.1 カラーパレット
- **プライマリ**: こえポン！ブランドカラー
- **レアリティカラー**:
  - N（ノーマル): #CCCCCC（グレー）
  - R（レア): #4CAF50（グリーン）
  - SR（スーパーレア): #2196F3（ブルー）
  - SSR（スーパースーパーレア): #FF9800（オレンジ）
  - UR（ウルトラレア): #9C27B0（パープル）

#### 1.2 タイポグラフィ
- **見出し**: 大胆で読みやすい日本語フォント
- **本文**: 可読性重視の標準フォント
- **数値**: 等幅フォント（価格・確率表示）

#### 1.3 アイコン・イラスト
- **ガチャボックス**: 魅力的な3Dスタイルアイコン
- **VTuberアバター**: 統一されたスタイルのアイコン
- **レアリティアイコン**: 星・宝石などのグラフィック

### 2. レスポンシブデザイン

#### 2.1 ブレイクポイント
- **Mobile**: 320px～768px（メインターゲット）
- **Tablet**: 768px～1024px
- **Desktop**: 1024px以上

#### 2.2 モバイル最適化
- **タッチフレンドリー**: 最小44px×44pxのタッチターゲット
- **片手操作**: 重要な操作は画面下部に配置
- **スワイプジェスチャー**: カード間のスワイプナビゲーション

### 3. アクセシビリティ

#### 3.1 WCAG 2.1 準拠
- **カラーコントラスト**: 4.5:1以上
- **フォーカス表示**: 明確なキーボードフォーカス
- **代替テキスト**: 画像・アイコンの適切なalt属性

#### 3.2 スクリーンリーダー対応
- **ARIA属性**: 適切なrole、aria-label設定
- **セマンティックHTML**: 意味のあるHTML構造
- **音声読み上げ**: 抽選結果の音声アナウンス

### 4. アニメーション・演出

#### 4.1 パフォーマンス要件
- **抽選演出**: 3秒以内で完了
- **画面遷移**: 300ms以内のスムーズな遷移
- **フレームレート**: 60fps維持

#### 4.2 演出仕様
- **ローディング**: スケルトンローダー・スピナー
- **ホバー効果**: カード・ボタンのマイクロインタラクション
- **結果演出**: レアリティに応じた差別化されたエフェクト

## 技術要件

### 1. 状態管理

#### 1.1 Zustandストア構成
```typescript
interface GachaStore {
  // ガチャ一覧
  gachaList: Gacha[]
  gachaListLoading: boolean
  gachaListError: string | null
  
  // 選択中のガチャ
  selectedGacha: GachaDetail | null
  selectedGachaLoading: boolean
  
  // 抽選状態
  drawState: 'idle' | 'drawing' | 'complete' | 'error'
  drawResult: DrawResult | null
  
  // 履歴
  drawHistory: DrawHistoryItem[]
  
  // アクション
  fetchGachaList: () => Promise<void>
  fetchGachaDetail: (id: string) => Promise<void>
  executeDraw: (gachaId: string, count: number) => Promise<void>
  clearDrawResult: () => void
}
```

#### 1.2 TanStack Query統合
- **キャッシュ戦略**: ガチャリスト5分、詳細情報1分
- **バックグラウンド更新**: フォーカス時の自動再取得
- **オプティミスティック更新**: 抽選実行時の即座なUI反映

### 2. API統合

#### 2.1 エンドポイント設計
```typescript
// ガチャ一覧取得
GET /api/v1/gacha
Query: { vtuber?: string, sort?: 'price' | 'popular' | 'latest' }

// ガチャ詳細取得  
GET /api/v1/gacha/:id

// 抽選実行
POST /api/v1/gacha/:id/draw
Body: { count: 1 | 10 }

// 抽選履歴取得
GET /api/v1/gacha/history
Query: { page?: number, limit?: number, vtuber?: string }
```

#### 2.2 エラーハンドリング
- **ネットワークエラー**: 自動リトライ（指数バックオフ）
- **認証エラー**: ログイン画面へリダイレクト
- **支払いエラー**: 詳細なエラーメッセージ表示
- **サーバーエラー**: フォールバック表示

### 3. リアルタイム通信

#### 3.1 Socket.io実装
```typescript
// ガチャ抽選結果の配信
socket.on('draw:progress', (data) => {
  // 抽選進行状況の更新
})

socket.on('draw:result', (data) => {
  // 最終結果の表示
})

socket.on('gacha:updated', (data) => {
  // ガチャ情報の更新（リアルタイム反映）
})
```

#### 3.2 接続管理
- **自動再接続**: 接続断時の自動復旧
- **接続状態表示**: オフライン時のユーザー通知
- **フォールバック**: WebSocket無効時のHTTPポーリング

### 4. パフォーマンス最適化

#### 4.1 コード分割
- **動的import**: 画面毎のコード分割
- **遅延ローディング**: 非重要コンポーネントの遅延読み込み
- **プリロード**: 次に表示される可能性の高い画面の先読み

#### 4.2 画像最適化
- **Next.js Image**: 自動最適化・WebP対応
- **レスポンシブ画像**: デバイス別サイズ最適化
- **遅延読み込み**: 画面外画像のlazyloading

## セキュリティ要件

### 1. 決済セキュリティ
- **HTTPS強制**: 全ての決済関連通信の暗号化
- **CSRFトークン**: 抽選実行時のCSRF保護
- **重複防止**: 同一抽選の重複実行防止

### 2. 不正対策
- **レート制限**: 短時間での大量抽選防止
- **入力検証**: 全てのユーザー入力の検証
- **セッション管理**: 適切な認証状態の維持

## テスト要件

### 1. 単体テスト（Jest + React Testing Library）
```typescript
// コンポーネントテスト例
describe('GachaCard', () => {
  it('should render gacha information correctly')
  it('should handle click events')
  it('should display loading state')
  it('should handle error state')
})

describe('GachaDrawPage', () => {
  it('should execute draw animation')
  it('should display draw result')
  it('should handle draw errors')
})
```

### 2. 統合テスト（React Testing Library）
- **画面遷移テスト**: ルーティング・ナビゲーション
- **状態管理テスト**: Zustandストアとの連携
- **API統合テスト**: モックAPIとの通信

### 3. E2Eテスト（Playwright）
```typescript
test('complete gacha flow', async ({ page }) => {
  // ガチャ一覧→詳細→抽選→結果のフルフロー
})

test('mobile gacha experience', async ({ page }) => {
  // モバイルデバイスでのガチャ体験
})
```

### 4. パフォーマンステスト
- **Core Web Vitals**: LCP、FID、CLS測定
- **抽選演出**: 3秒以内の完了確認
- **メモリ使用量**: 長時間利用での安定性確認

## 運用・監視要件

### 1. ログ・監視
```typescript
// 重要イベントのログ記録
logger.info('gacha:draw:start', { gachaId, userId, count })
logger.info('gacha:draw:complete', { gachaId, userId, result, duration })
logger.error('gacha:draw:error', { gachaId, userId, error })
```

### 2. メトリクス収集
- **抽選実行数**: VTuber別、ガチャ別の集計
- **エラー率**: 抽選失敗・支払い失敗率
- **パフォーマンス**: 画面表示時間、抽選処理時間
- **ユーザー行動**: 離脱率、コンバージョン率

### 3. A/Bテスト対応
- **UI変更**: ボタンデザイン、レイアウト変更
- **演出調整**: アニメーション速度・エフェクト
- **価格表示**: 価格表示方法の最適化

## 実装優先順位

### フェーズ1：基本機能（1週目）
1. **ガチャ一覧画面** - 基本的なリスト表示
2. **ガチャ詳細画面** - 詳細情報の表示
3. **基本的な状態管理** - Zustandストアの実装

### フェーズ2：コア機能（2週目）
1. **抽選実行機能** - 基本的な抽選処理
2. **結果表示** - シンプルな結果表示
3. **API統合** - バックエンドとの連携

### フェーズ3：演出・体験向上（3週目）
1. **抽選アニメーション** - 魅力的な演出の実装
2. **Socket.io統合** - リアルタイム通信
3. **履歴・統計機能** - 抽選履歴の実装

### フェーズ4：最適化・品質向上（4週目）
1. **パフォーマンス最適化** - 読み込み時間短縮
2. **アクセシビリティ向上** - WCAG準拠
3. **テスト充実** - カバレッジ向上

## 受け入れ基準

### 機能面
- [ ] ガチャ一覧・詳細・抽選の基本フローが動作する
- [ ] レスポンシブデザインが全デバイスで機能する
- [ ] 抽選演出が3秒以内で完了する
- [ ] エラーハンドリングが適切に機能する

### 品質面
- [ ] TypeScript型安全性が100%
- [ ] テストカバレッジが90%以上
- [ ] Core Web Vitalsが良好（LCP < 2.5s）
- [ ] WCAG 2.1 AA準拠

### セキュリティ面
- [ ] 決済フローが適切に保護されている
- [ ] CSRF・XSS対策が実装されている
- [ ] 入力検証が全箇所で実施されている

この要件定義に基づいて、魅力的で安全なガチャ体験を提供するフロントエンド実装を進めます。