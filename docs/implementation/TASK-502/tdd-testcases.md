# TASK-502: セキュリティテスト - テストケース設計

## テストケース概要

**合計65テストケース**を以下5つのカテゴリに分類して実装
- 認証・認可テスト: 15ケース (SC-001～SC-015)
- 入力検証テスト: 20ケース (SC-016～SC-035)  
- セッション管理テスト: 10ケース (SC-036～SC-045)
- 暗号化テスト: 12ケース (SC-046～SC-057)
- エラーハンドリングテスト: 8ケース (SC-058～SC-065)

## カテゴリ1: 認証・認可テスト (SC-001～SC-015)

### SC-001: パスワード強度検証
**目的**: 弱いパスワードでの登録拒否を確認
```gherkin
Given ユーザーが新規登録画面にアクセス
When パスワードに "123456" を入力
And 登録ボタンをクリック
Then "パスワードは8文字以上で英数字記号を含む必要があります"が表示される
```

### SC-002: ブルートフォース攻撃対策
**目的**: 連続ログイン失敗時のアカウントロック
```gherkin
Given 有効なユーザーアカウント
When 5回連続で間違ったパスワードでログインを試行
Then アカウントが15分間ロックされる
And "アカウントがロックされました。15分後に再試行してください"が表示される
```

### SC-003: セッションタイムアウト検証
**目的**: 非活動時の自動ログアウト
```gherkin
Given ユーザーがログイン済み
When 30分間非活動状態を維持
Then 自動的にログアウトされる
And ログイン画面にリダイレクトされる
```

### SC-004: 権限昇格防止（垂直）
**目的**: 一般ユーザーが管理者機能にアクセスできない
```gherkin
Given 一般ユーザーでログイン
When 管理者専用URL "/admin/users" に直接アクセス
Then 403 Forbidden エラーが返される
And アクセス試行がログに記録される
```

### SC-005: 権限昇格防止（水平）
**目的**: 他ユーザーのリソースにアクセスできない
```gherkin
Given ユーザーA（ID:123）でログイン
When ユーザーB（ID:456）のプロフィールURL "/users/456/profile" にアクセス
Then 403 Forbidden エラーが返される
And 不正アクセス試行がログに記録される
```

### SC-006: VTuber権限検証
**目的**: VTuberが自分のガチャのみ管理可能
```gherkin
Given VTuberユーザーでログイン
When 他のVTuberのガチャ編集URL "/gacha/999/edit" にアクセス
Then 403 Forbidden エラーが返される
```

### SC-007: JWT トークン改ざん検証
**目的**: 改ざんされたJWTトークンの拒否
```gherkin
Given 有効なJWTトークンを取得
When トークンのペイロード部分を改ざん
And 改ざんされたトークンでAPIにアクセス
Then 401 Unauthorized エラーが返される
```

### SC-008: トークン有効期限検証
**目的**: 期限切れトークンでのアクセス拒否
```gherkin
Given 有効期限切れのJWTトークン
When そのトークンでAPIにアクセス
Then 401 Unauthorized エラーが返される
And 再認証が要求される
```

### SC-009: 多要素認証準備
**目的**: MFA設定インターフェースの準備確認
```gherkin
Given 管理者ユーザーでログイン
When アカウント設定画面にアクセス
Then MFA設定オプションが表示される
And "準備中"ステータスが表示される
```

### SC-010: パスワードリセット検証
**目的**: 安全なパスワードリセット機能
```gherkin
Given 登録済みメールアドレス
When パスワードリセットを要求
Then 時限付きリセットトークンが生成される
And 1時間後にトークンが無効になる
```

### SC-011: 管理者権限継承防止
**目的**: 管理者がVTuber権限を付与できない
```gherkin
Given 管理者ユーザーでログイン
When 一般ユーザーに管理者権限を付与を試行
Then 操作が拒否される
And 権限変更ログが記録される
```

### SC-012: API認証ヘッダー検証
**目的**: Authorization ヘッダーなしのAPI拒否
```gherkin
Given APIエンドポイント "/api/users"
When Authorization ヘッダーなしでリクエスト
Then 401 Unauthorized エラーが返される
```

### SC-013: 不正なBearer トークン
**目的**: 無効なフォーマットのトークン拒否
```gherkin
Given 不正なフォーマットのBearerトークン
When APIにアクセス
Then 401 Unauthorized エラーが返される
And エラーログが記録される
```

### SC-014: ゲストユーザー制限
**目的**: 未認証ユーザーの機能制限
```gherkin
Given 未認証状態
When ガチャ購入を試行
Then ログイン画面にリダイレクトされる
```

### SC-015: 同時ログイン制限
**目的**: 同一アカウントの複数デバイス制限
```gherkin
Given ユーザーがデバイスAでログイン
When 同じユーザーがデバイスBでログイン
Then デバイスAのセッションが無効化される
```

## カテゴリ2: 入力検証テスト (SC-016～SC-035)

### SC-016: SQLインジェクション - 認証
**目的**: ログインフォームでのSQLインジェクション防止
```gherkin
Given ログイン画面
When メールフィールドに "admin@example.com'; DROP TABLE users; --" を入力
And パスワードフィールドに "password" を入力
And ログインボタンをクリック
Then SQLインジェクションが実行されない
And データベースが正常な状態を維持
```

### SC-017: SQLインジェクション - 検索
**目的**: ガチャ検索でのSQLインジェクション防止
```gherkin
Given ガチャ検索画面
When 検索フィールドに "'; DELETE FROM gachas; --" を入力
Then パラメータ化クエリにより安全に処理される
And データベース操作が実行されない
```

### SC-018: XSS - 反射型
**目的**: 検索結果でのXSS攻撃防止
```gherkin
Given ガチャ検索機能
When "<script>alert('XSS')</script>" で検索
Then スクリプトがエスケープされて表示される
And JavaScriptが実行されない
```

### SC-019: XSS - 持続型
**目的**: コメント投稿でのXSS攻撃防止
```gherkin
Given ガチャコメント投稿フォーム
When "<img src=x onerror=alert('XSS')>" を投稿
Then HTMLがエスケープされて保存される
And 他ユーザーが閲覧時にスクリプトが実行されない
```

### SC-020: CSRF攻撃防止
**目的**: 状態変更操作でのCSRF防止
```gherkin
Given 外部サイトから偽装されたフォーム
When メダル購入リクエストが送信される
And CSRFトークンが含まれない
Then リクエストが拒否される
And 403 Forbidden エラーが返される
```

### SC-021: ファイルアップロード制限 - サイズ
**目的**: 大きすぎるファイルのアップロード防止
```gherkin
Given VTuberコンテンツアップロード画面
When 10MBを超えるファイルをアップロード
Then "ファイルサイズは10MB以下にしてください"エラーが表示される
And アップロードが拒否される
```

### SC-022: ファイルアップロード制限 - 形式
**目的**: 許可されていないファイル形式の拒否
```gherkin
Given VTuberコンテンツアップロード画面
When .exe ファイルをアップロード試行
Then "サポートされていないファイル形式です"エラーが表示される
And アップロードが拒否される
```

### SC-023: ファイルアップロード - 悪意あるファイル
**目的**: マルウェアを含むファイルの検出
```gherkin
Given ファイルアップロード機能
When EICAR テストファイル（ウイルステストファイル）をアップロード
Then ウイルススキャンが実行される
And "危険なファイルが検出されました"エラーが表示される
```

### SC-024: パストラバーサル攻撃防止
**目的**: ディレクトリトラバーサル攻撃防止
```gherkin
Given ファイルダウンロード機能
When "../../etc/passwd" のようなパスでアクセス
Then アクセスが拒否される
And 許可されたディレクトリ外のファイルにアクセスできない
```

### SC-025: コマンドインジェクション防止
**目的**: OSコマンドインジェクション防止
```gherkin
Given ファイル処理機能
When ファイル名に "; rm -rf /" が含まれる
Then コマンドとして実行されない
And 安全にファイル名として処理される
```

### SC-026: XML External Entity (XXE) 防止
**目的**: XML解析でのXXE攻撃防止
```gherkin
Given XMLファイルのインポート機能
When XXE攻撃を含むXMLファイルをアップロード
Then 外部エンティティの読み込みが無効化される
And システムファイルへのアクセスが防止される
```

### SC-027: LDAP インジェクション防止
**目的**: LDAPクエリインジェクション防止
```gherkin
Given LDAP認証を使用する機能
When 特殊文字を含むユーザー名でログイン
Then LDAPクエリが安全にエスケープされる
And インジェクション攻撃が防止される
```

### SC-028: NoSQL インジェクション防止
**目的**: NoSQLデータベースでのインジェクション防止
```gherkin
Given MongoDBを使用するAPI
When "$where" を含む不正なクエリパラメータ
Then クエリが安全に検証される
And 不正なクエリ実行が防止される
```

### SC-029: HTTP ヘッダーインジェクション防止
**目的**: HTTPレスポンスヘッダーのインジェクション防止
```gherkin
Given リダイレクト機能
When 改行文字を含むURL "http://example.com%0d%0aSet-Cookie:malicious=1"
Then ヘッダーインジェクションが防止される
And 安全なリダイレクトのみ実行される
```

### SC-030: Server-Side Request Forgery (SSRF) 防止
**目的**: サーバーサイドリクエスト偽装防止
```gherkin
Given 外部URLから画像を取得する機能
When 内部ネットワークのURL "http://127.0.0.1:22" を指定
Then 内部ネットワークへのアクセスが防止される
And 許可されたドメインのみアクセス可能
```

### SC-031: 入力長制限
**目的**: 異常に長い入力データの制限
```gherkin
Given プロフィール編集フォーム
When 10000文字の自己紹介文を入力
Then "自己紹介文は500文字以内で入力してください"エラーが表示される
```

### SC-032: 数値範囲検証
**目的**: 不正な数値範囲の入力防止
```gherkin
Given メダル購入画面
When 購入数量に "-1" を入力
Then "購入数量は1以上を入力してください"エラーが表示される
```

### SC-033: メールアドレス形式検証
**目的**: 不正なメールアドレス形式の拒否
```gherkin
Given ユーザー登録画面
When メールアドレスに "invalid-email" を入力
Then "正しいメールアドレスを入力してください"エラーが表示される
```

### SC-034: 電話番号形式検証
**目的**: 不正な電話番号形式の拒否
```gherkin
Given プロフィール編集画面
When 電話番号に "abc-def-ghij" を入力
Then "正しい電話番号を入力してください"エラーが表示される
```

### SC-035: JSON インジェクション防止
**目的**: JSONペイロードのインジェクション防止
```gherkin
Given JSON APIエンドポイント
When 不正なJSONペイロードを送信
Then ペイロードが安全に検証される
And パース エラーが適切に処理される
```

## カテゴリ3: セッション管理テスト (SC-036～SC-045)

### SC-036: セキュアCookie設定
**目的**: セッションCookieのセキュア属性確認
```gherkin
Given ユーザーがHTTPS経由でログイン
When セッションCookieが設定される
Then Secure属性が設定されている
And HttpOnly属性が設定されている
And SameSite=Strict属性が設定されている
```

### SC-037: セッション固定攻撃防止
**目的**: ログイン時のセッションID再生成
```gherkin
Given 攻撃者が有効なセッションIDを事前に知っている
When 被害者がそのセッションIDでログイン
Then 新しいセッションIDが生成される
And 古いセッションIDは無効化される
```

### SC-038: セッション無効化（ログアウト）
**目的**: ログアウト時のセッション完全無効化
```gherkin
Given ユーザーがログイン済み
When ログアウトボタンをクリック
Then サーバー側でセッションが削除される
And クライアント側のCookieが削除される
And 古いセッションIDでのアクセスが拒否される
```

### SC-039: 同一ユーザーの多重セッション管理
**目的**: 複数デバイスでのセッション管理
```gherkin
Given ユーザーが複数デバイスでログイン
When 6つ目のデバイスでログイン
Then 最も古いセッションが無効化される
And 最大5セッションまでに制限される
```

### SC-040: セッションハイジャック防止
**目的**: セッション盗用の検出と防止
```gherkin
Given 正常なセッションが確立
When 異なるUser-Agentから同じセッションIDでアクセス
Then セッションが無効化される
And 再認証が要求される
And セキュリティアラートが発生
```

### SC-041: セッション情報漏洩防止
**目的**: URLクエリパラメータでのセッション情報漏洩防止
```gherkin
Given セッション管理システム
When セッションIDがURLに含まれない
Then Cookieのみでセッション管理される
And Refererヘッダーでセッション情報が漏洩しない
```

### SC-042: セッションストレージセキュリティ
**目的**: サーバー側セッション情報の暗号化
```gherkin
Given セッション情報がデータベースに保存される
When セッションデータを確認
Then 機密情報が暗号化されて保存されている
And 平文でのパスワード保存がない
```

### SC-043: 非活動タイムアウト設定
**目的**: 適切な非活動タイムアウトの実装
```gherkin
Given ユーザーがログイン済み
When 最後の活動から30分経過
Then 自動的にログアウトされる
And 次回アクセス時に再認証が要求される
```

### SC-044: 絶対タイムアウト設定
**目的**: 最大セッション継続時間の制限
```gherkin
Given ユーザーが継続的に活動中
When ログインから8時間経過
Then 強制的にログアウトされる
And セキュリティ上の理由が表示される
```

### SC-045: セッション情報最小化
**目的**: セッションに保存する情報の最小化
```gherkin
Given セッションストレージ
When セッション内容を確認
Then 必要最小限の情報のみ保存されている
And PII（個人識別情報）が含まれていない
```

## カテゴリ4: 暗号化テスト (SC-046～SC-057)

### SC-046: パスワードハッシュ化検証
**目的**: 安全なパスワードハッシュアルゴリズムの使用
```gherkin
Given 新規ユーザー登録
When パスワード "MySecurePass123!" を設定
Then bcryptまたはArgon2でハッシュ化される
And ソルトが自動生成される
And 同じパスワードでも異なるハッシュが生成される
```

### SC-047: TLS/SSL設定検証
**目的**: 通信暗号化の適切な設定確認
```gherkin
Given Webアプリケーション
When HTTPS接続でアクセス
Then TLS 1.3以上が使用される
And 強力な暗号化スイートが使用される
And 弱い暗号化プロトコル（SSLv3, TLS1.0, TLS1.1）が無効
```

### SC-048: 機密データ暗号化検証
**目的**: データベース内の機密情報暗号化
```gherkin
Given クレジットカード情報を保存
When データベースを直接確認
Then カード番号がAES-256で暗号化されている
And CVV情報が保存されていない
And PCI DSS準拠の暗号化が実装されている
```

### SC-049: 暗号鍵管理検証
**目的**: 暗号化キーの安全な管理
```gherkin
Given 暗号化システム
When 暗号化キーを確認
Then キーが環境変数またはキー管理システムに保存
And ソースコード内にハードコードされていない
And キーローテーションが実装されている
```

### SC-050: データ転送時暗号化
**目的**: API通信の暗号化確認
```gherkin
Given クライアント・サーバー間通信
When 機密データを送信
Then HTTPS経由で暗号化される
And 平文での機密データ送信がない
```

### SC-051: 暗号化キー長検証
**目的**: 適切な暗号化キー長の使用
```gherkin
Given 暗号化システム
When 暗号化キーを確認
Then AES-256（256ビット）キーが使用される
And RSAキーは2048ビット以上
And 弱いキー長（AES-128未満）が使用されていない
```

### SC-052: ランダム数生成器検証
**目的**: 暗号学的に安全な乱数生成
```gherkin
Given トークン生成機能
When セキュリティトークンを生成
Then 暗号学的擬似乱数生成器（CSPRNG）を使用
And 予測困難なトークンが生成される
And 標準的なMath.random()が使用されていない
```

### SC-053: ハッシュアルゴリズム検証
**目的**: 安全なハッシュアルゴリズムの使用
```gherkin
Given データ整合性検証
When ハッシュ値を生成
Then SHA-256以上のアルゴリズムを使用
And MD5、SHA-1などの弱いアルゴリズムが使用されていない
```

### SC-054: 暗号化設定の検証
**目的**: 適切な暗号化パラメータ設定
```gherkin
Given AES暗号化実装
When 暗号化パラメータを確認
Then CBC、GCMなどの安全なモードを使用
And ECBモードが使用されていない
And 適切な初期化ベクター（IV）が使用される
```

### SC-055: デジタル署名検証
**目的**: デジタル署名の実装確認
```gherkin
Given 重要なAPIレスポンス
When デジタル署名を確認
Then RSA-SHA256またはECDSA-SHA256で署名
And 署名検証が成功する
And 改ざんされたデータで署名検証が失敗
```

### SC-056: 証明書検証
**目的**: SSL証明書の適切な設定
```gherkin
Given HTTPS設定
When SSL証明書を確認
Then 有効期限内の証明書が使用される
And 信頼できる認証局（CA）が発行
And サブジェクト名がドメイン名と一致
```

### SC-057: 暗号化データ復号テスト
**目的**: 暗号化されたデータの復号確認
```gherkin
Given 暗号化されたユーザーデータ
When 適切な復号キーで復号
Then 元のデータが正しく復元される
And 不正なキーで復号が失敗する
```

## カテゴリ5: エラーハンドリングテスト (SC-058～SC-065)

### SC-058: 機密情報漏洩防止
**目的**: エラーメッセージでの機密情報漏洩防止
```gherkin
Given データベース接続エラーが発生
When エラーページが表示される
Then 一般的なエラーメッセージが表示される
And データベース接続文字列が表示されない
And スタックトレースが本番環境で表示されない
```

### SC-059: 詳細エラー情報の制御
**目的**: 開発環境と本番環境のエラー表示差異
```gherkin
Given 500 Internal Server Error が発生
When 本番環境でアクセス
Then "申し訳ありません。エラーが発生しました"が表示される
And システム内部の詳細情報が表示されない
```

### SC-060: セキュリティログ記録
**目的**: セキュリティイベントの適切なログ記録
```gherkin
Given 不正なログイン試行
When ログイン失敗が発生
Then セキュリティログに記録される
And IPアドレス、時刻、試行されたアカウントが記録
And PII情報（パスワード）は記録されない
```

### SC-061: ログ改ざん防止
**目的**: ログファイルの改ざん防止
```gherkin
Given セキュリティログシステム
When ログファイルを確認
Then ログファイルが読み取り専用に設定
And デジタル署名による整合性保護が実装
And ログローテーション時の署名継承が実装
```

### SC-062: 異常検知とアラート
**目的**: セキュリティ異常の自動検知
```gherkin
Given 異常検知システム
When 短時間に多数のログイン失敗
Then 自動的にアラートが生成される
And 管理者に通知が送信される
And 該当IPアドレスが一時的にブロックされる
```

### SC-063: エラー処理の一貫性
**目的**: 全システムでの一貫したエラー処理
```gherkin
Given 各種APIエンドポイント
When エラーが発生
Then 統一されたエラーレスポンス形式が返される
And 適切なHTTPステータスコードが設定される
```

### SC-064: ファイル処理エラー対応
**目的**: ファイル操作エラーの安全な処理
```gherkin
Given ファイルアップロード処理
When ディスク容量不足エラーが発生
Then 適切なエラーメッセージが表示される
And 一時ファイルが確実にクリーンアップされる
And システムファイルパス情報が漏洩しない
```

### SC-065: 例外処理セキュリティ
**目的**: 例外処理での情報漏洩防止
```gherkin
Given アプリケーション例外が発生
When 例外がキャッチされる
Then 機密情報を含まないメッセージが返される
And 詳細な例外情報はサーバーログのみに記録
And クライアントには安全なメッセージのみ表示
```

## テスト実行計画

### フェーズ1: 基盤セキュリティテスト（1日目）
- **認証・認可テスト**: SC-001～SC-015（15ケース）
- **セッション管理テスト**: SC-036～SC-045（10ケース）
- **実行時間**: 6時間
- **成功基準**: 100% パス

### フェーズ2: 入力検証・暗号化テスト（2日目）
- **入力検証テスト**: SC-016～SC-035（20ケース）
- **暗号化テスト**: SC-046～SC-057（12ケース）
- **実行時間**: 8時間
- **成功基準**: 100% パス

### フェーズ3: エラーハンドリング・統合テスト（3日目）
- **エラーハンドリングテスト**: SC-058～SC-065（8ケース）
- **OWASP ZAP自動スキャン**: 全機能
- **統合セキュリティテスト**: E2Eセキュリティシナリオ
- **実行時間**: 6時間
- **成功基準**: Critical/High脆弱性 0件

## 成功基準と品質メトリクス

### テスト実行成功基準
✅ **全65テストケース**: 100% パス
✅ **OWASP ZAP**: Critical/High脆弱性 0件
✅ **ASVS Level 2**: 95%以上準拠
✅ **実行時間**: 20時間以内完了

### セキュリティメトリクス
- **認証セキュリティ**: 100% (15/15)
- **入力検証**: 100% (20/20)
- **セッション管理**: 100% (10/10)
- **暗号化実装**: 100% (12/12)
- **エラーハンドリング**: 100% (8/8)

### 自動化率目標
- **自動実行可能テスト**: 85% (55/65)
- **手動確認必要テスト**: 15% (10/65)
- **CI/CD統合テスト**: 100% (65/65)