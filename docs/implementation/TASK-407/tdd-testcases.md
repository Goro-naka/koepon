# TASK-407: 管理者画面実装 - TDDテストケース設計

## テスト概要

管理者画面の全コンポーネント・機能に対するテストケースを設計し、TDD手法で実装する。

## テストカテゴリ

### 1. AdminDashboardPage コンポーネントテスト

#### 1.1 基本レンダリング・UI表示
- **ADM-001**: 管理者ダッシュボードの基本要素レンダリング
  - メトリクスカード群の表示確認
  - ナビゲーションメニューの表示
  - 期間選択フィルターの表示

- **ADM-002**: システム概要メトリクスの表示
  - 総ユーザー数・新規登録数の表示
  - 総VTuber数・承認待ち数の表示  
  - 売上関連メトリクスの表示
  - 数値フォーマット（カンマ区切り・通貨）の確認

- **ADM-003**: システムステータス表示
  - API応答時間・エラー率の表示
  - データベース接続状況表示
  - ストレージ使用量表示（プログレスバー）

#### 1.2 期間フィルター機能
- **ADM-004**: 期間選択フィルターの動作
  - プリセット期間（今日・7日・30日・90日）選択
  - カスタム期間選択機能
  - 期間変更時のデータ更新確認

- **ADM-005**: データ更新のローディング状態
  - 期間変更時のローディング表示
  - スケルトンローダーの表示
  - エラー時のフォールバック表示

#### 1.3 リアルタイム更新
- **ADM-006**: リアルタイムデータ更新
  - WebSocketかSSE経由でのデータ更新
  - メトリクスの自動更新確認
  - 新着アラートの表示更新

### 2. VTuberReviewPage コンポーネントテスト

#### 2.1 申請一覧表示・フィルター
- **VTR-001**: VTuber申請一覧の基本表示
  - 申請リストテーブルのレンダリング
  - 申請者情報（チャンネル名・申請日・ステータス）表示
  - ページネーション（20件/ページ）

- **VTR-002**: フィルター・検索機能
  - ステータス別フィルター（pending/under_review/approved/rejected）
  - 申請日範囲検索
  - 優先度フィルター（低・中・高・緊急）
  - 検索クエリでの絞り込み

- **VTR-003**: ソート機能
  - 申請日昇順・降順ソート
  - 更新日ソート
  - 優先度ソート

#### 2.2 審査詳細モーダル
- **VTR-004**: 申請詳細モーダル表示
  - モーダル開閉動作
  - 申請者基本情報表示
  - チャンネル情報・ソーシャルメディアリンク表示
  - アップロード画像のプレビュー表示

- **VTR-005**: 審査履歴・コメント表示
  - 過去の審査履歴一覧表示
  - コメント・メモの時系列表示
  - 審査者情報の表示

#### 2.3 審査操作
- **VTR-006**: 承認・却下操作
  - 承認ボタンクリック時の確認ダイアログ
  - 却下時の理由入力（必須検証）
  - 条件付承認機能
  - 操作後のステータス更新

- **VTR-007**: 一括操作
  - 複数申請の選択機能
  - 一括承認・一括却下
  - 一括操作時の確認ダイアログ

### 3. SystemMonitoringPage コンポーネントテスト

#### 3.1 システムメトリクス表示
- **SYM-001**: パフォーマンスメトリクス表示
  - CPU・メモリ・ディスク使用率表示
  - リアルタイムチャートのレンダリング
  - API応答時間グラフ表示

- **SYM-002**: エラー監視表示
  - エラーログ一覧テーブル
  - エラーレベル別色分け表示
  - エラー率推移グラフ

#### 3.2 アラート管理
- **SYM-003**: アラート一覧・管理
  - 現在のアラート一覧表示
  - アラート重要度別の表示
  - アラート確認・未確認状態管理

- **SYM-004**: アラート設定
  - 閾値設定フォーム
  - 通知チャネル設定
  - 設定保存・更新機能

### 4. UserManagementPage コンポーネントテスト

#### 4.1 ユーザー検索・一覧
- **USM-001**: ユーザー一覧表示
  - ユーザーテーブルの基本表示
  - ページネーション機能
  - ユーザー情報の適切な表示

- **USM-002**: 検索・フィルター機能
  - ユーザー名・メール検索
  - 登録日範囲検索
  - ステータス別フィルター
  - 高度な検索（課金額・利用状況）

#### 4.2 ユーザー詳細・操作
- **USM-003**: ユーザー詳細表示
  - ユーザー詳細モーダル表示
  - ガチャ利用履歴表示
  - 課金履歴・推しメダル残高表示
  - 特典ダウンロード履歴表示

- **USM-004**: ユーザー管理操作
  - アカウント停止・復活機能
  - パスワードリセット強制実行
  - 推しメダル残高調整
  - 特典付与・削除機能

### 5. 共通コンポーネントテスト

#### 5.1 AdminLayout
- **LAY-001**: 管理画面レイアウト表示
  - サイドバー・ヘッダー・メインコンテンツの配置
  - 折りたたみ可能サイドバー機能
  - レスポンシブレイアウト（タブレット・デスクトップ）

- **LAY-002**: ナビゲーション機能
  - サイドバーメニューの選択状態
  - ブレッドクラムナビゲーション
  - アクティブページの視覚的インジケーター

#### 5.2 共通UIコンポーネント
- **COM-001**: MetricsCard コンポーネント
  - メトリクスカードの基本表示
  - 数値・パーセンテージ・増減表示
  - ローディング・エラー状態表示

- **COM-002**: DataTable コンポーネント
  - テーブルデータの表示
  - ソート機能（昇順・降順）
  - ページネーション機能
  - 行選択機能（単体・複数）

- **COM-003**: ConfirmDialog コンポーネント  
  - 確認ダイアログの表示・非表示
  - メッセージ・ボタンのカスタマイズ
  - 確認・キャンセル動作

### 6. 状態管理（AdminStore）テスト

#### 6.1 Store初期化・基本状態
- **STO-001**: AdminStore初期状態
  - 初期値の正確な設定
  - 各状態プロパティの型確認
  - ローディング・エラー状態の初期値

- **STO-002**: 永続化設定
  - Zustand persist設定の確認
  - ローカルストレージへの保存確認
  - ストレージからの復元確認

#### 6.2 ダッシュボードメトリクス管理
- **STO-003**: メトリクスデータ取得
  - fetchDashboardMetrics成功時の状態更新
  - ローディング状態の適切な管理
  - エラー時の状態管理

- **STO-004**: リアルタイム更新
  - WebSocket接続・切断管理
  - リアルタイムデータ受信時の状態更新
  - 接続エラー時の再接続処理

#### 6.3 VTuber審査管理
- **STO-005**: 申請データ管理
  - fetchApplications成功・失敗処理
  - フィルター・ページネーション状態管理
  - 選択状態の管理

- **STO-006**: 審査操作
  - reviewApplication実行時の楽観的更新
  - API成功・失敗時の状態復元
  - 一括操作の状態管理

#### 6.4 システム監視データ管理
- **STO-007**: システムメトリクス管理
  - リアルタイムメトリクス更新
  - 過去データの蓄積・管理
  - 閾値超過時のアラート生成

- **STO-008**: エラー・アラート管理
  - エラーログの蓄積・管理
  - アラート状態管理
  - 確認・未確認状態の更新

#### 6.5 ユーザー管理
- **STO-009**: ユーザーデータ管理
  - fetchUsers成功・失敗処理
  - 検索・フィルター状態管理
  - ユーザー詳細データのキャッシュ

- **STO-010**: ユーザー操作
  - performUserAction楽観的更新
  - 操作成功・失敗時の状態処理
  - 操作ログの記録

### 7. API連携テスト

#### 7.1 管理者API呼び出し
- **API-001**: ダッシュボードAPI
  - GET /api/admin/dashboard/metrics 正常呼び出し
  - パラメーター（period）の適切な送信
  - レスポンスデータの型チェック

- **API-002**: VTuber審査API
  - GET /api/admin/vtuber-applications 呼び出し
  - POST /api/admin/vtuber-applications/{id}/review
  - PUT /api/admin/vtuber-applications/{id}/status

- **API-003**: システム監視API
  - GET /api/admin/system/metrics 呼び出し
  - GET /api/admin/api/metrics
  - GET /api/admin/errors

- **API-004**: ユーザー管理API
  - GET /api/admin/users 検索・フィルター
  - POST /api/admin/users/{id}/suspend
  - POST /api/admin/users/{id}/adjust-medals

#### 7.2 エラーハンドリング
- **API-005**: ネットワークエラー処理
  - タイムアウト時の適切な処理
  - 接続エラー時のユーザーフィードバック
  - 自動リトライ機能

- **API-006**: 認証・認可エラー
  - 401 Unauthorized時のログアウト処理
  - 403 Forbidden時の権限エラー表示
  - トークンリフレッシュ処理

- **API-007**: サーバーエラー処理
  - 500系エラー時のエラー表示
  - エラー詳細情報の表示
  - 再試行ボタンの提供

### 8. 認証・認可テスト

#### 8.1 管理者権限チェック
- **AUTH-001**: ルートレベル権限制御
  - 非管理者ユーザーのアクセス拒否
  - 権限不足時のリダイレクト
  - セッション期限切れ時の処理

- **AUTH-002**: コンポーネントレベル権限制御
  - 管理者のみ表示するUI要素
  - 操作ボタンの表示・非表示制御
  - 権限に応じた機能制限

#### 8.2 操作ログ・監査
- **AUTH-003**: 管理操作ログ記録
  - 全管理操作のログ出力確認
  - ログフォーマットの確認
  - ログ送信の成功・失敗処理

### 9. パフォーマンステスト

#### 9.1 初期表示パフォーマンス
- **PERF-001**: ページ表示速度
  - ダッシュボード 3秒以内表示
  - データテーブル 2秒以内表示
  - 詳細モーダル 1秒以内表示

- **PERF-002**: 大量データ処理
  - 大量ユーザーリスト表示
  - 仮想化テーブルの動作確認
  - ページネーション性能

#### 9.2 リアルタイム更新パフォーマンス
- **PERF-003**: WebSocket通信
  - リアルタイム更新の遅延測定
  - 大量メトリクス更新時の性能
  - メモリリーク確認

### 10. アクセシビリティテスト

#### 10.1 キーボードナビゲーション
- **A11Y-001**: キーボード操作
  - Tab順序の適切性
  - 全操作のキーボード実行可能性
  - フォーカス状態の視覚的表示

- **A11Y-002**: スクリーンリーダー対応
  - ARIA属性の適切な設定
  - 動的コンテンツの読み上げ
  - フォーム項目のラベル関連付け

#### 10.2 色・コントラスト
- **A11Y-003**: カラーコントラスト
  - WCAG 2.1 AA準拠の色使用
  - 4.5:1以上のコントラスト比
  - 色のみに依存しない情報表示

### 11. レスポンシブデザインテスト

#### 11.1 ブレークポイント対応
- **RWD-001**: モバイル対応（640px以下）
  - サイドバーの折りたたみ表示
  - テーブルの横スクロール
  - タッチフレンドリーなUI

- **RWD-002**: タブレット対応（641-1024px）
  - 管理操作に適したレイアウト
  - 2カラムレイアウトの適切な表示
  - タブレット特有の操作対応

- **RWD-003**: デスクトップ対応（1025px以上）
  - フルレイアウトの表示
  - 複数情報の同時表示
  - マルチタスク対応UI

### 12. エラーハンドリング・エッジケーステスト

#### 12.1 データ異常系テスト
- **EDGE-001**: 空データ・null値処理
  - メトリクスが0の場合の表示
  - null・undefined値の安全な処理
  - 空配列・空オブジェクトの表示

- **EDGE-002**: 異常値データ処理
  - 極端に大きい数値の表示
  - 負の数値の適切な処理
  - 不正なフォーマットデータの処理

#### 12.2 UI操作エッジケース
- **EDGE-003**: 連続操作・競合状態
  - 連続クリック防止
  - 同時API呼び出し防止
  - Race condition対策

- **EDGE-004**: ブラウザ制限・互換性
  - ローカルストレージ容量制限
  - 古いブラウザでの動作確認
  - JavaScript無効時の動作

## モックデータ定義

### 1. AdminDashboardMetrics モックデータ
```typescript
export const mockDashboardMetrics: AdminDashboardMetrics = {
  systemOverview: {
    totalUsers: 15420,
    newUsersToday: 142,
    newUsersThisMonth: 2847,
    totalVTubers: 89,
    pendingApplications: 23,
    approvalRate: 87.5,
    totalRevenue: 4250000,
    monthlyRevenue: 892000,
    revenueGrowth: 15.2,
    activeUsersDAU: 3420,
    activeUsersMAU: 8750,
    systemAlerts: [
      {
        id: 'alert-1',
        level: 'warning',
        message: 'API応答時間が閾値を超えています',
        timestamp: '2024-01-15T10:30:00Z',
        acknowledged: false,
        source: 'api-monitor'
      }
    ]
  },
  systemStatus: {
    apiResponseTime: 245,
    errorRate: 0.8,
    databaseStatus: 'healthy',
    cacheHitRate: 92.5,
    storageUsage: {
      used: 128000000000,
      total: 500000000000,
      percentage: 25.6
    }
  },
  dateRange: {
    startDate: '2024-01-01',
    endDate: '2024-01-15'
  }
}
```

### 2. VTuberApplicationReview モックデータ
```typescript
export const mockApplications: VTuberApplicationReview[] = [
  {
    id: 'app-1',
    applicant: {
      id: 'user-1',
      channelName: 'あかりちゃんねる',
      email: 'akari@example.com',
      applicationDate: '2024-01-10T09:00:00Z'
    },
    status: 'pending',
    priority: 'high',
    reviewHistory: [
      {
        id: 'review-1',
        reviewerId: 'admin-1',
        reviewerName: '管理者田中',
        action: 'review_started',
        timestamp: '2024-01-10T09:30:00Z'
      }
    ],
    currentReviewer: 'admin-1',
    estimatedReviewTime: '2024-01-12T18:00:00Z'
  }
]
```

### 3. SystemMetrics モックデータ
```typescript
export const mockSystemMetrics: SystemMetrics[] = [
  {
    timestamp: '2024-01-15T10:00:00Z',
    cpu: {
      usage: 45.2,
      cores: 8
    },
    memory: {
      used: 6442450944,
      total: 17179869184,
      percentage: 37.5
    },
    disk: {
      used: 128849018880,
      total: 1000204886016,
      percentage: 12.9
    },
    network: {
      inbound: 5242880,
      outbound: 3145728
    }
  }
]
```

### 4. AdminUserView モックデータ
```typescript
export const mockUsers: AdminUserView[] = [
  {
    id: 'user-1',
    email: 'user1@example.com',
    displayName: 'ユーザー1',
    registrationDate: '2023-06-15T12:00:00Z',
    lastLoginDate: '2024-01-14T18:30:00Z',
    status: 'active',
    totalGachaDraws: 156,
    totalSpent: 23400,
    medalBalance: 15420,
    rewardCount: 89,
    riskScore: 0.2
  }
]
```

## テスト実装戦略

### 1. テスト分割アプローチ
- **コンポーネント単位**: 各ページコンポーネントを個別にテスト
- **機能単位**: 関連するコンポーネント群を統合テスト
- **エンドツーエンド**: ユーザーフロー全体をテスト

### 2. モック戦略
- **API モック**: MSW (Mock Service Worker) 使用
- **WebSocket モック**: 手動実装のモック
- **ストレージモック**: localStorage/sessionStorage モック

### 3. テスト環境設定
- **テストランナー**: Jest
- **UI テスト**: React Testing Library
- **E2E テスト**: Playwright
- **カバレッジ**: 80% 以上を目標

### 4. 継続的テスト
- **テスト自動化**: CI/CD パイプラインで自動実行
- **リグレッションテスト**: 主要機能の回帰テスト
- **パフォーマンステスト**: 定期的なパフォーマンス監視

## 推定テスト工数

- **コンポーネントテスト**: 42テスト × 30分 = 21時間
- **状態管理テスト**: 10テスト × 45分 = 7.5時間
- **API連携テスト**: 7テスト × 30分 = 3.5時間
- **認証・認可テスト**: 3テスト × 60分 = 3時間
- **パフォーマンステスト**: 3テスト × 90分 = 4.5時間
- **アクセシビリティテスト**: 3テスト × 60分 = 3時間
- **エッジケーステスト**: 4テスト × 45分 = 3時間

**総推定工数**: 約45.5時間

このテストケース設計により、管理者画面の品質と信頼性を確保し、TDD手法で段階的に実装を進めます。