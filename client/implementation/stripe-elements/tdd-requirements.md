# Stripe Elementsæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ  - è¦ä»¶å®šç¾©

## ğŸ“‹ è¦ä»¶æ¦‚è¦

### 1. ãƒ“ã‚¸ãƒã‚¹è¦ä»¶
- **ç›®çš„**: ã‚¬ãƒãƒ£è³¼å…¥æ™‚ã®æ±ºæ¸ˆå‡¦ç†ã‚’Stripe Elementsã§å®Ÿè£…
- **å¯¾è±¡**: ã‚¬ãƒãƒ£è³¼å…¥ãƒ•ãƒ­ãƒ¼ï¼ˆ100å††/1000å††ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚¬ãƒãƒ£è³¼å…¥è€…ï¼‰
- **æˆåŠŸåŸºæº–**: ã‚µã‚¤ãƒˆå†…å®Œçµã®æ±ºæ¸ˆä½“é¨“ã‚’æä¾›

### 2. æ©Ÿèƒ½è¦ä»¶

#### 2.1 æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼
```
[ã‚¬ãƒãƒ£è©³ç´°] â†’ [æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ] â†’ [Payment Intent] â†’ [æ±ºæ¸ˆå®Œäº†] â†’ [ã‚¬ãƒãƒ£æŠ½é¸]
```

#### 2.2 å®Ÿè£…å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**A. `StripeProvider.tsx`**
- Stripe Elementsã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- publishable keyã®ç®¡ç†
- ãƒ†ãƒ¼ãƒè¨­å®š

**B. `PaymentForm.tsx`** 
- CardElementã‚’å«ã‚€æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ 
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†

**C. `useStripePayment.ts`**
- æ±ºæ¸ˆå‡¦ç†ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
- Payment Intentä½œæˆãƒ»ç¢ºèª
- ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ç®¡ç†

#### 2.3 æ±ºæ¸ˆæ‰‹é †
1. ã‚¬ãƒãƒ£é¸æŠï¼ˆä¾¡æ ¼: 100å†† or 1000å††ï¼‰
2. æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆCard Elementï¼‰
3. ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
4. Payment Intentä½œæˆï¼ˆ/api/payments/create-intentï¼‰
5. æ±ºæ¸ˆç¢ºèªãƒ»å®Ÿè¡Œï¼ˆstripe.confirmCardPaymentï¼‰
6. æˆåŠŸæ™‚: ã‚¬ãƒãƒ£æŠ½é¸å®Ÿè¡Œ
7. å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãƒ»å†è©¦è¡Œ

### 3. æŠ€è¡“è¦ä»¶

#### 3.1 Stripe Elementsè¨­å®š
```typescript
// å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
import { loadStripe } from '@stripe/stripe-js'
import { Elements, CardElement, useStripe, useElements } from '@stripe/react-stripe-js'

// è¨­å®š
const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)
```

#### 3.2 APIé€£æº
- **POST** `/api/payments/create-intent` - Payment Intentä½œæˆ
- **POST** `/api/payments/confirm` - æ±ºæ¸ˆç¢ºèª
- **POST** `/api/gacha/execute` - ã‚¬ãƒãƒ£æŠ½é¸å®Ÿè¡Œ

#### 3.3 å‹å®šç¾©
```typescript
interface PaymentData {
  gachaId: string
  amount: number // 100 or 1000
  pullType: 'single' | 'ten'
}

interface PaymentResult {
  success: boolean
  paymentIntentId: string
  error?: string
}
```

### 4. UXè¦ä»¶

#### 4.1 ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
- ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ä¸­: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
- æ±ºæ¸ˆå‡¦ç†ä¸­: ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ– + ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
- Payment Intentä½œæˆä¸­: ã€Œæ±ºæ¸ˆæº–å‚™ä¸­...ã€è¡¨ç¤º

#### 4.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸‹ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- æ±ºæ¸ˆå¤±æ•—: Alert + å†è©¦è¡Œãƒœã‚¿ãƒ³
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã€Œæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€

#### 4.3 æˆåŠŸæ™‚ã®ä½“é¨“
- æ±ºæ¸ˆå®Œäº†: ã€Œæ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸã€è¡¨ç¤º
- å³åº§ã«ã‚¬ãƒãƒ£æŠ½é¸ç”»é¢ã«é·ç§»
- æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹

### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

#### 5.1 PCI DSSæº–æ‹ 
- ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯ç›´æ¥ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãªã„
- Stripe Elementsã«ã‚ˆã‚‹è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
- HTTPSå¿…é ˆ

#### 5.2 CSPè¨­å®š
```html
<meta http-equiv="Content-Security-Policy" 
      content="connect-src 'self' https://api.stripe.com;">
```

### 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

#### 6.1 èª­ã¿è¾¼ã¿æ™‚é–“
- Stripeã‚¹ã‚¯ãƒªãƒ—ãƒˆ: é…å»¶èª­ã¿è¾¼ã¿
- Payment Intentä½œæˆ: 2ç§’ä»¥å†…
- æ±ºæ¸ˆå®Œäº†: 3ç§’ä»¥å†…

#### 6.2 ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºæœ€é©åŒ–
```typescript
// Tree shakingå¯¾å¿œ
import { loadStripe } from '@stripe/stripe-js'
// å¿…è¦ãªè¦ç´ ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
```

### 7. æ—¢å­˜å®Ÿè£…ã¨ã®çµ±åˆ

#### 7.1 ç¾åœ¨ã®ãƒ¢ãƒƒã‚¯å®Ÿè£… (src/lib/stripe.ts)
```typescript
// å‰Šé™¤å¯¾è±¡: ãƒ¢ãƒƒã‚¯æ±ºæ¸ˆå‡¦ç†
export async function processStripePayment(data: StripePaymentData): Promise<StripePaymentResult> {
  // TODO: å®Ÿéš›ã®Stripeæ±ºæ¸ˆå‡¦ç†ã‚’å®Ÿè£…
  console.log('Processing Stripe payment:', data)
  
  // ãƒ¢ãƒƒã‚¯å®Ÿè£…
  return {
    success: true,
    id: `pi_mock_${Date.now()}`
  }
}
```

#### 7.2 ã‚¬ãƒãƒ£Storeçµ±åˆ (src/stores/gacha.ts)
```typescript
// æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã‚’å®Ÿéš›ã®Stripeçµæœã«å¤‰æ›´
const payment = await processStripePayment({
  gachaId,
  amount,
  pullType
})

if (payment.success) {
  // æŠ½é¸å®Ÿè¡Œ
  await executeGacha(payment.id)
}
```

### 8. å—ã‘å…¥ã‚ŒåŸºæº–

#### 8.1 æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- [ ] ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œ
- [ ] Payment Intentæ­£å¸¸ä½œæˆ
- [ ] æ±ºæ¸ˆæˆåŠŸæ™‚ã®ã‚¬ãƒãƒ£å®Ÿè¡Œ
- [ ] æ±ºæ¸ˆå¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- [ ] å†è©¦è¡Œæ©Ÿèƒ½å‹•ä½œ

#### 8.2 UXãƒ†ã‚¹ãƒˆ  
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®é©åˆ‡ãªè¡¨ç¤º
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ˜ç¢ºæ€§
- [ ] ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼ˆARIAå±æ€§ï¼‰

#### 8.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- [ ] ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®éä¿å­˜ç¢ºèª
- [ ] HTTPSé€šä¿¡ç¢ºèª
- [ ] CSPæº–æ‹ ç¢ºèª

#### 8.4 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºé€Ÿåº¦ï¼ˆ2ç§’ä»¥å†…ï¼‰
- [ ] Payment Intentä½œæˆé€Ÿåº¦ï¼ˆ2ç§’ä»¥å†…ï¼‰
- [ ] æ±ºæ¸ˆå®Œäº†é€Ÿåº¦ï¼ˆ3ç§’ä»¥å†…ï¼‰

## ğŸ¯ å®Ÿè£…å„ªå…ˆé †ä½

1. **Phase 1**: åŸºæœ¬å®Ÿè£…
   - StripeProvider.tsx
   - PaymentForm.tsx
   - useStripePayment.ts

2. **Phase 2**: çµ±åˆå®Ÿè£…
   - ã‚¬ãƒãƒ£Storeã¨ã®é€£æº
   - ãƒ¢ãƒƒã‚¯å®Ÿè£…ã®ç½®ãæ›ãˆ
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

3. **Phase 3**: UXå‘ä¸Š
   - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æœ€é©åŒ–
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„
   - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
client/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ payment/
â”‚   â”‚       â”œâ”€â”€ StripeProvider.tsx      # NEW
â”‚   â”‚       â”œâ”€â”€ PaymentForm.tsx         # NEW
â”‚   â”‚       â””â”€â”€ PaymentButton.tsx       # NEW
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useStripePayment.ts         # NEW
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ stripe.ts                   # MODIFY
â”‚   â””â”€â”€ stores/
â”‚       â””â”€â”€ gacha.ts                    # MODIFY
```

---

**è¦ä»¶å®šç¾©å®Œäº†**: æ¬¡æ®µéšã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¨­è¨ˆã«é€²ã¿ã¾ã™ã€‚