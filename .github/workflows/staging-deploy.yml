name: Staging Deployment

on:
  push:
    branches: [staging]
  pull_request:
    branches: [staging]

env:
  NODE_VERSION: '20'

jobs:
  # ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: koepon_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd client && npm ci
          cd ../api && npm ci
          
      - name: Lint check
        run: |
          cd client && npm run lint
          cd ../api && npm run lint
          
      - name: Type check
        run: |
          cd client && npm run type-check
          cd ../api && npm run build
          
      - name: Unit tests
        run: |
          cd client && npm run test
          cd ../api && npm run test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/koepon_test
          
      - name: Security tests
        run: |
          cd security-tests && npm run test:security
          
      - name: Performance tests (Light)
        run: |
          cd performance-tests && npm run test:api

  # Supabase ç’°å¢ƒç®¡ç†
  deploy-supabase:
    name: Deploy Supabase
    needs: test-suite
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: Link to Staging Project
        run: supabase link --project-ref ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
      - name: Deploy Database Changes
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
      - name: Deploy Edge Functions
        run: supabase functions deploy --project-ref ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
      - name: Seed Test Data
        run: |
          psql "$SUPABASE_DB_URL" -c "SELECT create_staging_test_data();"
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_STAGING_DB_URL }}

  # Frontend Deployment (Vercel)  
  deploy-frontend:
    name: Deploy Frontend to Vercel
    needs: [test-suite, deploy-supabase]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Vercel CLI
        run: npm install -g vercel
        
      - name: Deploy to Vercel Staging
        run: |
          cd client
          vercel --token ${{ secrets.VERCEL_TOKEN }} \
            --env NODE_ENV=staging \
            --env NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_STAGING_URL }} \
            --env NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_STAGING_ANON_KEY }} \
            --env SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_STAGING_SERVICE_KEY }} \
            --env REDIS_URL=${{ secrets.UPSTASH_STAGING_REDIS_URL }} \
            --env NEXT_PUBLIC_SITE_URL=https://staging-koepon.vercel.app \
            --build-env NODE_ENV=staging \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --project-name koepon-staging \
            --prod
            
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ Deployment (Vercel Functions)
  deploy-backend:
    name: Deploy Backend APIs
    needs: deploy-supabase
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Vercel CLI
        run: npm install -g vercel
        
      - name: Deploy API to Vercel
        run: |
          cd api
          vercel --token ${{ secrets.VERCEL_TOKEN }} \
            --env NODE_ENV=staging \
            --env SUPABASE_URL=${{ secrets.SUPABASE_STAGING_URL }} \
            --env SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_STAGING_SERVICE_KEY }} \
            --env REDIS_URL=${{ secrets.UPSTASH_STAGING_REDIS_URL }} \
            --env STRIPE_SECRET_KEY=${{ secrets.STRIPE_TEST_SECRET_KEY }} \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --project-name koepon-api-staging \
            --prod

  # çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  integration-tests:
    name: Integration Tests
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Playwright
        run: |
          cd client/e2e
          npm ci
          npx playwright install --with-deps
          
      - name: Wait for deployment
        run: sleep 30
        
      - name: Run E2E Tests
        run: |
          cd client/e2e
          npx playwright test --config=playwright.staging.config.ts
        env:
          STAGING_BASE_URL: https://staging-koepon.vercel.app
          STAGING_API_URL: https://koepon-api-staging.vercel.app
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-staging
          path: client/e2e/test-results/
          
      - name: Run Performance Tests
        run: |
          cd performance-tests
          node staging-performance-validation.js
        env:
          STAGING_API_URL: https://koepon-api-staging.vercel.app
          
      - name: Run Security Scan
        run: |
          cd security-tests
          npm run test:staging-security
        env:
          STAGING_BASE_URL: https://staging-koepon.vercel.app

  # UATç’°å¢ƒæº–å‚™ãƒ»é€šçŸ¥
  prepare-uat:
    name: Prepare UAT Environment
    needs: integration-tests
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Generate UAT Report
        run: |
          echo "# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† ğŸ‰" > uat-report.md
          echo "" >> uat-report.md
          echo "## ç’°å¢ƒæƒ…å ±" >> uat-report.md
          echo "- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: https://staging-koepon.vercel.app" >> uat-report.md
          echo "- **API**: https://koepon-api-staging.vercel.app" >> uat-report.md
          echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚**: $(date)" >> uat-report.md
          echo "- **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> uat-report.md
          echo "" >> uat-report.md
          echo "## ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ" >> uat-report.md
          echo "- **ç®¡ç†è€…**: staging-admin@example.com / password123" >> uat-report.md
          echo "- **VTuber**: staging-vtuber@example.com / password123" >> uat-report.md  
          echo "- **ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼**: staging-user@example.com / password123" >> uat-report.md
          echo "" >> uat-report.md
          echo "## UAT å®Ÿæ–½é …ç›®" >> uat-report.md
          echo "- [ ] åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ" >> uat-report.md
          echo "- [ ] æ–°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ" >> uat-report.md
          echo "- [ ] å›å¸°ãƒ†ã‚¹ãƒˆ" >> uat-report.md
          echo "- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ" >> uat-report.md
          echo "- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ" >> uat-report.md
          echo "- [ ] ãƒ“ã‚¸ãƒã‚¹æ‰¿èª" >> uat-report.md
          
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ğŸ‰ *ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†*
            
            **ç’°å¢ƒ**: https://staging-koepon.vercel.app
            **API**: https://koepon-api-staging.vercel.app
            **ã‚³ãƒŸãƒƒãƒˆ**: `${{ github.sha }}`
            
            UATé–‹å§‹å¯èƒ½ã§ã™ï¼ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:
            â€¢ ç®¡ç†è€…: `staging-admin@example.com`
            â€¢ VTuber: `staging-vtuber@example.com`
            â€¢ ä¸€èˆ¬: `staging-user@example.com`
            
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: `password123`
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              target_url: 'https://staging-koepon.vercel.app',
              description: 'Staging deployment successful'
            });

  # å¤±æ•—æ™‚ã®å‡¦ç†
  notify-failure:
    name: Notify Failure
    needs: [test-suite, deploy-supabase, deploy-frontend, deploy-backend, integration-tests]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Notify Slack (Failure)
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            âŒ *ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—*
            
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}
            **ã‚³ãƒŸãƒƒãƒˆ**: `${{ github.sha }}`
            **å®Ÿè¡ŒURL**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ç¢ºèªãƒ»ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}